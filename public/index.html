<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESPOND Safeguarding Simulator</title>
    <meta name="description" content="Interactive scenario-based safeguarding training powered by the RESPOND Framework.">
    <link rel="icon" type="image/png" href="https://github.com/Daddymac1969/respond/blob/main/RESPOND%20Concept%20copyrighted%20(1).png?raw=true">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; height: 100%; }
        body { font-family: 'Sora', -apple-system, sans-serif; line-height: 1.6; color: #C8D1DC; min-height: 100vh; background: #0c1018; }
        :root {
            --bg: #0c1018; --bg-elevated: #141b27; --bg-surface: #1a2332; --bg-overlay: #1e2a3a;
            --border: #253245; --border-light: #2e3e54;
            --text: #C8D1DC; --text-dim: #6b7a8d; --text-bright: #F1F5F9;
            --accent: #ff6b35;
            --step-r: #24437b; --step-e: #235e4b; --step-s: #a4684e; --step-p: #cd372b;
            --step-o: #ebaf24; --step-n: #287bc9; --step-d: #8625eb;
            --active-step: var(--step-r); --step-rgb: 36,67,123;
        }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes criticalFlash { 0% { background: #2a0a0a; } 25% { background: #3d0f0f; } 50% { background: #2a0a0a; } 100% { background: #1e0808; } }
        @keyframes dotBounce { 0%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-6px); } }
        @keyframes scoreReveal { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .fade-up { animation: fadeUp 0.6s cubic-bezier(0.16,1,0.3,1) both; }

        .screen-menu { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; background: radial-gradient(ellipse at 30% 20%, rgba(36,67,123,0.08) 0%, transparent 60%), radial-gradient(ellipse at 70% 80%, rgba(134,37,235,0.06) 0%, transparent 60%), var(--bg); }
        .menu-wrap { max-width: 520px; width: 100%; }
        .menu-hero { text-align: center; padding: 48px 32px 40px; }
        .menu-dots { display: flex; gap: 10px; justify-content: center; margin-bottom: 32px; }
        .menu-dots .md { width: 12px; height: 12px; border-radius: 50%; transition: transform 0.3s; }
        .menu-dots .md:hover { transform: scale(1.4); }
        .menu-title { font-size: 44px; font-weight: 800; color: var(--text-bright); letter-spacing: -1.5px; margin: 0 0 4px; }
        .menu-subtitle { font-size: 15px; font-weight: 400; color: var(--text-dim); letter-spacing: 3px; text-transform: uppercase; margin: 0 0 28px; }
        .menu-desc { font-size: 14px; color: var(--text); line-height: 1.8; max-width: 400px; margin: 0 auto 32px; }
        .menu-steps { display: flex; flex-direction: column; gap: 0; margin: 0 0 32px; }
        .menu-step { display: flex; align-items: center; gap: 16px; padding: 14px 20px; border-bottom: 1px solid var(--border); }
        .menu-step:last-child { border-bottom: none; }
        .ms-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .ms-num { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-dim); min-width: 18px; }
        .ms-text { font-size: 13px; color: var(--text); }
        .btn-begin { display: block; width: 100%; padding: 16px 32px; border: none; border-radius: 10px; cursor: pointer; background: linear-gradient(135deg, #24437b, #287bc9); color: #fff; font-family: 'Sora', sans-serif; font-size: 15px; font-weight: 700; letter-spacing: 0.5px; transition: all 0.3s; }
        .btn-begin:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(36,67,123,0.4); }
        #menu-error { display: none; padding: 12px 16px; border-radius: 10px; margin-top: 16px; background: #1e0808; border: 1px solid #5c1a1a; color: #f87171; font-size: 13px; }
        .menu-footer { text-align: center; margin-top: 20px; font-size: 11px; color: var(--text-dim); }
        .menu-footer a { color: var(--text-dim); text-decoration: underline; text-underline-offset: 2px; }

        .screen-loading { display: none; align-items: center; justify-content: center; flex-direction: column; gap: 24px; min-height: 100vh; background: radial-gradient(ellipse at 50% 50%, rgba(36,67,123,0.1) 0%, transparent 70%), var(--bg); }
        .loading-bounce { display: flex; gap: 8px; }
        .loading-bounce .lb { width: 12px; height: 12px; border-radius: 50%; }
        .loading-bounce .lb:nth-child(1) { animation: dotBounce 1.2s 0s infinite; }
        .loading-bounce .lb:nth-child(2) { animation: dotBounce 1.2s 0.1s infinite; }
        .loading-bounce .lb:nth-child(3) { animation: dotBounce 1.2s 0.2s infinite; }
        .loading-bounce .lb:nth-child(4) { animation: dotBounce 1.2s 0.3s infinite; }
        .loading-bounce .lb:nth-child(5) { animation: dotBounce 1.2s 0.4s infinite; }
        .loading-bounce .lb:nth-child(6) { animation: dotBounce 1.2s 0.5s infinite; }
        .loading-bounce .lb:nth-child(7) { animation: dotBounce 1.2s 0.6s infinite; }
        .loading-text { font-size: 14px; color: var(--text-dim); font-weight: 500; }

        #screen-game { display: none; min-height: 100vh; }
        .game-header { position: sticky; top: 0; z-index: 50; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; height: 52px; background: rgba(12,16,24,0.85); backdrop-filter: blur(20px) saturate(1.2); border-bottom: 1px solid var(--border); }
        .gh-left { display: flex; align-items: center; gap: 10px; }
        .gh-logo { width: 24px; height: 24px; border-radius: 5px; object-fit: contain; }
        .gh-brand { font-weight: 700; font-size: 13px; color: var(--text-bright); text-decoration: none; letter-spacing: -0.3px; }
        .gh-divider { width: 1px; height: 20px; background: var(--border); }
        .rag-pill { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; letter-spacing: 1.5px; }
        .rag-pill .rp-dot { width: 6px; height: 6px; border-radius: 50%; }
        .rag-GREEN { background: rgba(5,150,105,0.15); color: #34d399; border: 1px solid rgba(5,150,105,0.3); } .rag-GREEN .rp-dot { background: #34d399; }
        .rag-AMBER { background: rgba(217,119,6,0.15); color: #fbbf24; border: 1px solid rgba(217,119,6,0.3); } .rag-AMBER .rp-dot { background: #fbbf24; }
        .rag-RED { background: rgba(220,38,38,0.15); color: #f87171; border: 1px solid rgba(220,38,38,0.3); } .rag-RED .rp-dot { background: #f87171; }
        .gh-right { display: flex; align-items: center; gap: 12px; }
        .gh-step-label { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-dim); }
        .btn-exit { padding: 5px 14px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); font-size: 11px; font-weight: 600; cursor: pointer; font-family: 'Sora', sans-serif; transition: all 0.2s; }
        .btn-exit:hover { border-color: #f87171; color: #f87171; }

        .step-journey { display: flex; align-items: stretch; height: 48px; border-bottom: 1px solid var(--border); background: var(--bg-elevated); overflow-x: auto; }
        .sj-step { flex: 1; display: flex; align-items: center; justify-content: center; gap: 7px; min-width: 0; padding: 0 8px; font-size: 12px; font-weight: 600; color: var(--text-dim); transition: all 0.4s ease; border-bottom: 3px solid transparent; opacity: 0.35; }
        .sj-step.active { opacity: 1; border-bottom-color: var(--active-step); background: linear-gradient(180deg, transparent 0%, rgba(var(--step-rgb), 0.08) 100%); }
        .sj-step.past { opacity: 0.7; }
        .sj-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; transition: all 0.4s; }
        .sj-step.active .sj-dot { width: 10px; height: 10px; box-shadow: 0 0 10px currentColor; }
        .sj-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sj-score { font-family: 'DM Mono', monospace; font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 10px; color: #fff; flex-shrink: 0; }
        .sj-sc-hi { background: #059669; } .sj-sc-mid { background: #b45309; } .sj-sc-lo { background: #dc2626; }

        .game-body { max-width: 720px; margin: 0 auto; padding: 0 20px 200px; }

        .scene-card { margin: 24px 0 0; padding: 32px; border-radius: 16px; background: var(--bg-surface); border: 1px solid var(--border); border-left: 4px solid var(--active-step); animation: fadeUp 0.7s cubic-bezier(0.16,1,0.3,1) both; }
        .scene-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 16px; }
        .scene-badge-dot { width: 8px; height: 8px; border-radius: 50%; }
        .scene-title { font-size: 22px; font-weight: 800; color: var(--text-bright); letter-spacing: -0.5px; margin: 0 0 6px; line-height: 1.3; }
        .scene-setting { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-dim); margin: 0 0 20px; }
        .scene-text { font-size: 15px; line-height: 1.9; color: var(--text); white-space: pre-wrap; }

        .prompt-card { margin: 16px 0 0; padding: 16px 20px; border-radius: 12px; background: rgba(var(--step-rgb), 0.06); border: 1px solid rgba(var(--step-rgb), 0.15); animation: fadeUp 0.5s 0.2s cubic-bezier(0.16,1,0.3,1) both; }
        .prompt-step-tag { display: inline-block; font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 6px; opacity: 0.7; }
        .prompt-text { font-size: 14px; font-weight: 600; color: var(--text-bright); line-height: 1.6; }

        .user-bubble { margin: 14px 0 0; margin-left: auto; max-width: 88%; padding: 14px 18px; border-radius: 14px 14px 4px 14px; background: var(--bg-overlay); border: 1px solid var(--border-light); animation: fadeUp 0.3s ease both; }
        .user-bubble p { font-size: 14px; line-height: 1.7; color: var(--text); margin: 0; }
        .user-label { font-size: 10px; font-weight: 600; color: var(--text-dim); text-align: right; margin-bottom: 4px; letter-spacing: 0.5px; }

        .assess-card { margin: 14px 0 0; padding: 20px; border-radius: 14px; display: flex; gap: 16px; align-items: flex-start; animation: fadeUp 0.5s cubic-bezier(0.16,1,0.3,1) both; }
        .assess-card.normal { background: var(--bg-elevated); border: 1px solid var(--border); }
        .assess-card.critical { background: #1e0808; border: 1px solid #5c1a1a; animation: criticalFlash 1.5s ease, fadeUp 0.5s ease both; }
        .assess-score-circle { width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-family: 'DM Mono', monospace; font-size: 18px; font-weight: 700; color: #fff; animation: scoreReveal 0.4s 0.2s cubic-bezier(0.34,1.56,0.64,1) both; }
        .assess-body { flex: 1; min-width: 0; }
        .assess-verdict { font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
        .assess-text { font-size: 13px; line-height: 1.7; color: var(--text); }
        .critical-alert { margin-top: 12px; padding: 12px 16px; border-radius: 8px; background: rgba(220,38,38,0.1); border: 1px solid rgba(220,38,38,0.25); font-size: 13px; line-height: 1.6; color: #fca5a5; font-weight: 500; }
        .critical-alert-tag { display: inline-block; background: #dc2626; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 800; letter-spacing: 1px; margin-bottom: 6px; }

        .dev-card { margin: 20px 0 0; padding: 28px; border-radius: 14px; background: var(--bg-surface); border: 1px solid var(--border); border-left: 4px solid var(--active-step); animation: fadeUp 0.6s 0.1s cubic-bezier(0.16,1,0.3,1) both; }
        .dev-text { font-size: 15px; line-height: 1.9; color: var(--text); white-space: pre-wrap; }

        .typing-indicator { margin: 14px 0 0; padding: 16px 20px; display: flex; align-items: center; gap: 12px; animation: fadeIn 0.3s ease; }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dots .td { width: 6px; height: 6px; border-radius: 50%; background: var(--text-dim); }
        .typing-dots .td:nth-child(1) { animation: dotBounce 1.2s 0s infinite; }
        .typing-dots .td:nth-child(2) { animation: dotBounce 1.2s 0.15s infinite; }
        .typing-dots .td:nth-child(3) { animation: dotBounce 1.2s 0.3s infinite; }
        .typing-label { font-size: 12px; color: var(--text-dim); font-weight: 500; }

        .input-dock { position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; padding: 16px 20px 24px; background: linear-gradient(180deg, transparent 0%, var(--bg) 30%); }
        .input-dock-inner { max-width: 720px; margin: 0 auto; }
        .input-context { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 0 4px; }
        .ic-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .ic-step { font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
        .ic-hint { font-size: 11px; color: var(--text-dim); }
        .input-wrap { display: flex; gap: 10px; align-items: flex-end; padding: 12px; border-radius: 14px; background: var(--bg-surface); border: 1px solid var(--border); transition: border-color 0.3s; }
        .input-wrap:focus-within { border-color: var(--active-step); box-shadow: 0 0 0 3px rgba(var(--step-rgb), 0.1); }
        .input-ta { flex: 1; padding: 6px 8px; border: none; background: transparent; color: var(--text-bright); font-size: 14px; line-height: 1.6; resize: none; font-family: 'Sora', sans-serif; outline: none; }
        .input-ta::placeholder { color: var(--text-dim); }
        .input-ta:disabled { opacity: 0.4; }
        .btn-submit { padding: 10px 20px; border-radius: 10px; border: none; background: var(--active-step); color: #fff; font-size: 13px; font-weight: 700; cursor: pointer; font-family: 'Sora', sans-serif; white-space: nowrap; transition: all 0.2s; flex-shrink: 0; }
        .btn-submit:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn-submit:disabled { opacity: 0.3; cursor: not-allowed; transform: none; filter: none; }
        .input-meta { margin: 6px 0 0; padding: 0 4px; font-size: 10px; color: var(--text-dim); display: flex; justify-content: space-between; }

        .debrief-wrap { animation: fadeUp 0.8s cubic-bezier(0.16,1,0.3,1) both; margin-top: 24px; }
        .db-header { text-align: center; padding: 40px 24px 32px; border-radius: 16px 16px 0 0; background: linear-gradient(180deg, var(--bg-surface) 0%, var(--bg-elevated) 100%); border: 1px solid var(--border); border-bottom: none; }
        .db-dots { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .db-dots .dbd { width: 10px; height: 10px; border-radius: 50%; }
        .db-title-text { font-size: 12px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 4px; }
        .db-case-title { font-size: 20px; font-weight: 800; color: var(--text-bright); letter-spacing: -0.3px; margin-bottom: 24px; }
        .db-score-cluster { display: flex; align-items: center; justify-content: center; gap: 32px; flex-wrap: wrap; }
        .db-big-score { font-size: 56px; font-weight: 800; line-height: 1; animation: scoreReveal 0.6s cubic-bezier(0.34,1.56,0.64,1) both; }
        .db-big-score span { font-size: 20px; color: var(--text-dim); font-weight: 400; }
        .db-grade-badge { font-size: 14px; font-weight: 700; padding: 8px 20px; border-radius: 8px; border: 2px solid; }
        .db-steps { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; border: 1px solid var(--border); border-top: none; background: var(--border); }
        .db-step-cell { background: var(--bg-elevated); padding: 16px 8px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .dsc-dot { width: 10px; height: 10px; border-radius: 50%; }
        .dsc-letter { font-size: 11px; font-weight: 700; color: var(--text-dim); }
        .dsc-score { font-size: 24px; font-weight: 800; line-height: 1; animation: scoreReveal 0.5s cubic-bezier(0.34,1.56,0.64,1) both; }
        .dsc-score span { font-size: 10px; color: var(--text-dim); font-weight: 400; }
        .dsc-fb { font-size: 10px; color: var(--text-dim); line-height: 1.4; margin-top: 4px; }
        .db-body { border: 1px solid var(--border); border-top: none; border-radius: 0 0 16px 16px; overflow: hidden; }
        .db-section { padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .db-section:last-child { border-bottom: none; }
        .db-section-title { font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
        .db-section.strengths { background: rgba(5,150,105,0.04); } .db-section.strengths .db-section-title { color: #34d399; } .db-section.strengths p { color: #a7f3d0; font-size: 13px; line-height: 1.7; margin: 4px 0; }
        .db-section.areas { background: rgba(255,107,53,0.04); } .db-section.areas .db-section-title { color: var(--accent); } .db-section.areas p { color: #ffd9c4; font-size: 13px; line-height: 1.7; margin: 4px 0; }
        .db-section.learning { background: rgba(37,99,235,0.04); } .db-section.learning .db-section-title { color: #93c5fd; } .db-section.learning p { color: #dbeafe; font-size: 14px; line-height: 1.8; margin: 0; }
        .db-section.refs .db-section-title { color: var(--text-dim); } .db-section.refs p { color: var(--text-dim); font-size: 12px; line-height: 1.5; margin: 2px 0; }
        .db-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; padding-bottom: 24px; flex-wrap: wrap; }
        .btn-action { padding: 12px 24px; border-radius: 10px; border: none; cursor: pointer; font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 700; transition: all 0.2s; }
        .btn-action.primary { background: linear-gradient(135deg, #24437b, #287bc9); color: #fff; }
        .btn-action.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(36,67,123,0.4); }
        .btn-action.secondary { background: var(--bg-surface); border: 1px solid var(--border); color: var(--text); }
        .btn-action.ghost { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
        .msg-error { margin: 14px 0; padding: 14px 18px; border-radius: 12px; background: #1e0808; border: 1px solid #5c1a1a; color: #f87171; font-size: 13px; }
        @media (max-width: 640px) { .menu-title { font-size: 32px; } .menu-hero { padding: 32px 20px; } .sj-label { display: none; } .sj-step { min-width: 36px; gap: 0; flex-direction: column; padding: 0 4px; } .db-steps { grid-template-columns: repeat(4, 1fr); } .scene-card,.dev-card { padding: 20px; } .scene-title { font-size: 18px; } .db-big-score { font-size: 40px; } }
    </style>
</head>
<body>
<div id="screen-menu" class="screen-menu">
    <div class="menu-wrap">
        <div class="menu-hero">
            <div class="menu-dots" id="menu-dots"></div>
            <h1 class="menu-title">RESPOND</h1>
            <p class="menu-subtitle">Safeguarding Simulator</p>
            <p class="menu-desc">Navigate realistic safeguarding scenarios in real-time. Every decision is assessed against the RESPOND framework — building the recall-under-pressure skills that protect children.</p>
            <div class="menu-steps" id="menu-steps"></div>
            <div id="menu-error"></div>
            <button class="btn-begin" onclick="startScenario()">Begin Scenario</button>
        </div>
        <p class="menu-footer"><a href="https://www.respondsafeguarding.org/" target="_blank" rel="noopener">respondsafeguarding.org</a> · Contact <a href="mailto:darren@respondsafeguarding.org">darren@respondsafeguarding.org</a> for access</p>
    </div>
</div>
<div id="screen-loading" class="screen-loading">
    <div class="loading-bounce" id="loading-dots"></div>
    <p class="loading-text">Generating your scenario...</p>
</div>
<div id="screen-game">
    <div class="game-header">
        <div class="gh-left">
            <img src="https://github.com/Daddymac1969/respond/blob/main/RESPOND%20Concept%20copyrighted%20(1).png?raw=true" alt="" class="gh-logo" onerror="this.style.display='none'">
            <a href="https://www.respondsafeguarding.org/" target="_blank" rel="noopener" class="gh-brand">RESPOND</a>
            <div class="gh-divider"></div>
            <span id="rag-badge" class="rag-pill rag-GREEN"><span class="rp-dot"></span>GREEN</span>
        </div>
        <div class="gh-right">
            <span class="gh-step-label" id="header-step">STEP: RECOGNISE</span>
            <button class="btn-exit" onclick="resetGame()">✕ Exit</button>
        </div>
    </div>
    <div class="step-journey" id="step-journey"></div>
    <div class="game-body" id="game-body"></div>
    <div class="input-dock" id="input-dock">
        <div class="input-dock-inner">
            <div class="input-context" id="input-context">
                <span class="ic-dot" id="ic-dot"></span>
                <span class="ic-step" id="ic-step">RECOGNISE</span>
                <span class="ic-hint" id="ic-hint">— Identify the concern</span>
            </div>
            <div class="input-wrap">
                <textarea id="user-input" class="input-ta" rows="2" placeholder="Describe what you would do..."></textarea>
                <button id="btn-submit" class="btn-submit" onclick="submitResponse()">Submit →</button>
            </div>
            <div class="input-meta"><span>Shift+Enter for new line</span><span>Training simulation only</span></div>
        </div>
    </div>
</div>
<script>
const STEPS = [
    { key: "RECOGNISE", letter: "R", color: "#24437b", rgb: "36,67,123", label: "Recognise", sub: "Identify the concern" },
    { key: "ENGAGE", letter: "E", color: "#235e4b", rgb: "35,94,75", label: "Engage", sub: "Communicate effectively" },
    { key: "SUPPORT", letter: "S", color: "#a4684e", rgb: "164,104,78", label: "Support", sub: "Maintain composure" },
    { key: "PAUSE", letter: "P", color: "#cd372b", rgb: "205,55,43", label: "Pause", sub: "Consider your approach" },
    { key: "OFFER", letter: "O", color: "#ebaf24", rgb: "235,175,36", label: "Offer", sub: "Model alternatives" },
    { key: "NOTIFY", letter: "N", color: "#287bc9", rgb: "40,123,201", label: "Notify", sub: "Report the issue" },
    { key: "DOCUMENT", letter: "D", color: "#8625eb", rgb: "134,37,235", label: "Document", sub: "Record observations" },
];
const SCENARIO_TYPES = [
    "A nuanced scenario involving possible emotional abuse with cultural complexity",
    "A scenario involving concerning online behaviour and potential grooming",
    "A scenario involving peer-on-peer abuse disguised as normal social dynamics",
    "A scenario involving a student showing signs of neglect in a boarding context",
    "A scenario involving possible exploitation with contextual safeguarding factors",
    "A scenario involving self-harm indicators masked by academic pressure",
    "A scenario involving discrimination and identity-based harm",
    "A scenario involving a student displaying signs of radicalisation",
    "A scenario involving concerning staff-student boundary issues",
    "A scenario involving child-on-child sexual harassment normalised by peers",
];
const DEMO_NAMES = {
    male: ["James","Oliver","Mohammed","Kwame","Ravi","Carlos","Liam","Tom\u00e1s","Yusuf","Dmitri","Ethan","Kofi","Arjun","Matteo","Hiroshi","Zane","Idris","Finn","Rafael","Jakub","Noah","Tariq","Seb","Diego","Amir","Callum","Marcus","Theo","Luca","Andr\u00e9","Patrick","Chen Wei","Hassan","Nikolai","Brandon","Oscar","Jamal","Hugo","Aarav","Kenji"],
    female: ["Sophie","Fatima","Mei-Lin","Chioma","Isabella","Aoife","Priya","Elena","Yuki","Zara","Chloe","Amina","Leila","Freya","Valentina","Ngozi","Saoirse","Hana","Rosa","Ingrid","Grace","Nadia","Lena","Adaeze","Marta","Sienna","Daria","Kira","Esme","Anya","Thandi","Astrid","Maya","Lucia","Jasmine","Pilar","Emilia","Aisha","Kayla","Mina"],
    nonbinary: ["Alex","Sam","Jordan","Rowan","Kai","Ash","Quinn","Avery","River","Sky"]
};
const DEMO_ORIGINS = ["British","American","German","French","Nigerian","Kenyan","South African","Ghanaian","Indian","Pakistani","Sri Lankan","Bangladeshi","Japanese","Korean","Chinese","Filipino","Brazilian","Mexican","Colombian","Argentine","Irish","Polish","Italian","Spanish","Swedish","Norwegian","Dutch","Turkish","Egyptian","Lebanese","Iranian","Australian","Canadian","Jamaican","Trinidadian","Thai","Vietnamese","Russian","Ukrainian","Czech","Greek","Portuguese","Moroccan","Ethiopian","Tanzanian","New Zealand","Saudi Arabian","Emirati","Singaporean","Malaysian"];
const DEMO_GRADES = ["Pre-K","K","1","2","3","4","5","6","7","8","9","10","11","12"];
const DEMO_SETTINGS = ["Classroom during morning lessons","Campus dining hall at lunch","Dorm corridor during evening check-in","Sports field after practice","Art studio during free period","Library at study hall","School reception area at drop-off","Music practice room after school","Campus courtyard between classes","Boarding house common room after dinner","Computer lab during a lesson","Science lab during a practical","Backstage during rehearsals","Campus caf\u00e9 on a Saturday morning","School minibus returning from a trip","Medical centre waiting area","Corridor outside the head's office","Sixth form study area mid-morning","Swimming pool changing rooms","Chapel or reflection space during assembly"];
const DEMO_DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
let usedNames = [];
function randomDemographic() {
    const genderRoll = Math.random();
    const gender = genderRoll < 0.42 ? "male" : genderRoll < 0.84 ? "female" : "nonbinary";
    const namePool = DEMO_NAMES[gender].filter(n => !usedNames.includes(n));
    const pool = namePool.length > 0 ? namePool : DEMO_NAMES[gender];
    const name = pool[Math.floor(Math.random() * pool.length)];
    usedNames.push(name); if (usedNames.length > 20) usedNames = usedNames.slice(-10);
    return { name, gender, origin: pick(DEMO_ORIGINS), grade: pick(DEMO_GRADES), setting: pick(DEMO_SETTINGS), day: pick(DEMO_DAYS) };
}
function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

const SYSTEM_PROMPT = "You are the RESPOND Safeguarding Training Simulator \u2014 an AI engine for an interactive safeguarding training game used in UK schools (particularly international boarding schools). The RESPOND Framework is from respondsafeguarding.org.\n\n## YOUR ROLE\nYou guide staff through realistic safeguarding scenarios, assessing their decisions against the RESPOND framework (Recognise \u2192 Engage \u2192 Support \u2192 Pause \u2192 Offer \u2192 Notify \u2192 Document).\n\n## THE RESPOND FRAMEWORK\n\n**R \u2013 RECOGNISE (Identify the concern)**: Identify safeguarding signs and trust your observations. Professional curiosity; noticing changes; cultural awareness. Ask: what type of harm? Who is involved? What context factors (people/places/platforms/patterns)?\n\n**E \u2013 ENGAGE (Communicate effectively)**: Approach students with empathy and respect to build trust. Non-judgmental; age-appropriate; avoid leading questions. Use TED questions (Tell me, Explain, Describe \u2014 NOT \"why\"). Say: \"I believe you. This is not your fault. You're safe right now.\"\n\n**S \u2013 SUPPORT (Maintain composure)**: Consider what immediate emotional and practical assistance is tailored to needs. Validate without investigating; meet basic needs; cultural humility. Safety check: \"Are you safe now? Need medical attention?\" Provide private space, water, reassurance.\n\n**P \u2013 PAUSE (Consider your approach)**: Take time to think carefully before acting to ensure appropriate response. DON'T investigate, promise secrecy, blame victim, or promise outcomes. Check policy; avoid investigation impulse. Use Three Lenses: Risk \u2022 Rights \u2022 Resources. IMPORTANT: Pause is an internal mental checkpoint, not going silent. It means stopping to think before your next action \u2014 staff can still be present and reassuring while pausing internally.\n\n**O \u2013 OFFER (Model alternatives)**: Identify relevant services and resources promptly. Only offer what you can deliver; respect autonomy where safe. Explain next steps: DSL notification, possible police/CSC, parent contact. Support options: school counselor, trusted adult, external services.\n\n**N \u2013 NOTIFY (Report the issue)**: Inform designated safeguarding leads and senior managers as required. Within 30 minutes (immediately if crime in progress). Report: time, student details, what was disclosed, safety concerns, alleged perpetrator, evidence mentioned (NOT viewed). DSL coordinates with Police, CSC, SARC, parents.\n\n**D \u2013 DOCUMENT (Record observations)**: Keep accurate, detailed records of safeguarding actions and observations. Record within 30 minutes. Use exact words: \"Student said: [quote]\" \u2014 NO paraphrasing. Include: date, time, location, who present, student's words, demeanour, your actions. Use GOLD format (Ground, Observe, Language, Do).\n\n## RAG THRESHOLDS\n- **GREEN**: Low-level concern, monitor and record.\n- **AMBER**: Escalating concern or pattern. DSL must assess.\n- **RED**: Immediate risk of significant harm. DSL notified NOW.\n\n## GAME MECHANICS\n\n### When asked to generate a scenario:\nCreate a realistic, nuanced scenario for an international boarding school. The scenario should:\n- NOT reveal what the safeguarding issue is \u2014 staff must identify it\n- Include subtle indicators that require professional curiosity\n- Have cultural, contextual, or environmental complexity\n- Unfold in layers\n- Be challenging but realistic\n\nRespond with ONLY valid JSON (no markdown, no backticks):\n{\n  \"scenario_id\": \"unique_id\",\n  \"title\": \"Brief evocative title\",\n  \"setting\": \"Where/when this takes place\",\n  \"initial_observation\": \"What the staff member sees/hears \u2014 3-5 sentences MAX, concise but vivid, NO safeguarding labels\",\n  \"hidden_issue\": \"FOR SCORING ONLY - what is actually happening\",\n  \"severity\": \"GREEN|AMBER|RED\",\n  \"key_indicators\": [\"indicator1\", \"indicator2\", \"indicator3\"],\n  \"respond_step\": \"RECOGNISE\",\n  \"prompt_to_user\": \"A question asking the user what they notice and what they would do\"\n}\n\n### When assessing a user response:\nEvaluate against the current RESPOND step. Consider:\n- Did they identify the right concern?\n- Did they take appropriate action?\n- Did they avoid common pitfalls?\n- Was their response trauma-informed and culturally sensitive?\n- Give credit for contextually appropriate responses, even if they don't use exact framework phrases\n\nRespond with ONLY valid JSON:\n{\n  \"score\": 1-10,\n  \"assessment\": \"Brief, specific feedback\",\n  \"respond_step_met\": true/false,\n  \"critical_miss\": true/false,\n  \"critical_miss_detail\": \"Only if critical_miss is true\",\n  \"next_development\": \"The scenario develops further \u2014 2-3 sentences MAX, keep it tight\",\n  \"current_step\": \"RECOGNISE|ENGAGE|SUPPORT|PAUSE|OFFER|NOTIFY|DOCUMENT\",\n  \"prompt_to_user\": \"Next question\",\n  \"case_concluded\": false,\n  \"rag_status\": \"GREEN|AMBER|RED\"\n}\n\n### When concluding a case:\n{\n  \"score\": 1-10,\n  \"assessment\": \"Final comprehensive feedback\",\n  \"respond_step_met\": true,\n  \"case_concluded\": true,\n  \"final_debrief\": {\n    \"overall_score\": 1-100,\n    \"grade\": \"Outstanding|Good|Requires Improvement|Inadequate\",\n    \"rag_final\": \"GREEN|AMBER|RED\",\n    \"step_scores\": {\n      \"RECOGNISE\": {\"score\": 1-10, \"feedback\": \"...\"},\n      \"ENGAGE\": {\"score\": 1-10, \"feedback\": \"...\"},\n      \"SUPPORT\": {\"score\": 1-10, \"feedback\": \"...\"},\n      \"PAUSE\": {\"score\": 1-10, \"feedback\": \"...\"},\n      \"OFFER\": {\"score\": 1-10, \"feedback\": \"...\"},\n      \"NOTIFY\": {\"score\": 1-10, \"feedback\": \"...\"},\n      \"DOCUMENT\": {\"score\": 1-10, \"feedback\": \"...\"}\n    },\n    \"strengths\": [\"strength1\", \"strength2\"],\n    \"areas_for_development\": [\"area1\", \"area2\"],\n    \"key_learning\": \"The most important takeaway\",\n    \"statutory_references\": [\"KCSIE 2025 reference\", \"Working Together 2023 reference\"]\n  },\n  \"next_development\": \"\",\n  \"current_step\": \"COMPLETE\",\n  \"prompt_to_user\": \"\"\n}\n\n## RULES\n- Never reveal the hidden issue until the debrief\n- Make scenarios culturally nuanced (international boarding school)\n- Include red herrings \u2014 real life is messy\n- Reward professional curiosity, penalise assumptions\n- Flag dangerous choices as critical_miss\n- Keep tone supportive and educational\n- Keep ALL text outputs CONCISE \u2014 scenarios 3-5 sentences, developments 2-3 sentences, assessments 1-2 sentences. Staff need to make decisions quickly, not read essays\n\n## INTERNATIONAL SCHOOL TERMINOLOGY\nUse international school terms throughout:\n- \"Grade\" (NOT \"Year\") \u2014 e.g. \"Grade 9 student\", \"Grade 11\"\n- \"Faculty\" or \"staff\" (NOT \"teachers\" alone)\n- \"Campus\" (NOT \"school grounds\")\n- \"Dorm\" or \"boarding house\" (NOT \"house\" alone)\n- \"Semester\" or \"trimester\" (NOT \"term\")\n- \"Parent conference\" (NOT \"parents' evening\")\n- \"College counselor\" (NOT \"careers adviser\")\n- Students may hold multiple passports and move between countries\n\n## ANTI-BIAS REQUIREMENTS \u2014 CRITICAL\nThe user prompt will specify exact demographics (name, gender, nationality, grade, setting). You MUST use these exactly as given \u2014 do not substitute, alter, or ignore them.\n\nAdditional rules:\n- NEVER make the safeguarding issue stereotypically linked to the student's ethnicity or nationality\n- Academic pressure scenarios can happen to ANY nationality \u2014 not just East Asian or South Asian students\n- Online grooming, exploitation, and abuse affect ALL demographics equally\n- Perpetrators should reflect realistic diversity \u2014 not default to any single demographic\n- Avoid cultural stereotyping in how the scenario unfolds\n- Family dynamics should be varied and never stereotyped by nationality";

let state = { phase:"menu", currentStep:"RECOGNISE", ragStatus:"GREEN", stepScores:{}, conversationHistory:[], scenarioCount:0, loading:false, scenarioTitle:"", scenarioSetting:"", hiddenIssue:"", userResponses:[] };
const GOOGLE_SHEET_WEBHOOK = "";
let lastDebrief = null;

function esc(t) { const d = document.createElement("div"); d.textContent = t; return d.innerHTML; }
function ragHtml(status) { return `<span class="rag-pill rag-${status}"><span class="rp-dot"></span>${status}</span>`; }
function getActiveStep() { return STEPS.find(s => s.key === state.currentStep) || STEPS[0]; }

function updateStepTheming() {
    const s = getActiveStep();
    document.documentElement.style.setProperty('--active-step', s.color);
    document.documentElement.style.setProperty('--step-rgb', s.rgb);
    const dot = document.getElementById('ic-dot');
    const step = document.getElementById('ic-step');
    const hint = document.getElementById('ic-hint');
    if (dot) dot.style.background = s.color;
    if (step) { step.textContent = s.label.toUpperCase(); step.style.color = s.color; }
    if (hint) hint.textContent = `\u2014 ${s.sub}`;
    const submit = document.getElementById('btn-submit');
    if (submit) submit.style.background = s.color;
}

function initUI() {
    document.getElementById("menu-dots").innerHTML = STEPS.map(s => `<div class="md" style="background:${s.color}"></div>`).join("");
    document.getElementById("menu-steps").innerHTML = STEPS.map((s,i) => `<div class="menu-step" style="animation:fadeUp 0.5s ${0.1+i*0.06}s both"><span class="ms-dot" style="background:${s.color}"></span><span class="ms-num">${s.letter}</span><span class="ms-text"><strong>${s.label}</strong> \u2014 ${s.sub}</span></div>`).join("");
    document.getElementById("loading-dots").innerHTML = STEPS.map(s => `<div class="lb" style="background:${s.color}"></div>`).join("");
    document.getElementById("user-input").addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); submitResponse(); } });
}

function showScreen(n) { ["screen-menu","screen-loading","screen-game"].forEach(id => { document.getElementById(id).style.display = "none"; }); const el = document.getElementById(`screen-${n}`); el.style.display = (n === "menu" || n === "loading") ? "flex" : "block"; }
function resetGame() { state = { phase:"menu", currentStep:"RECOGNISE", ragStatus:"GREEN", stepScores:{}, conversationHistory:[], scenarioCount:state.scenarioCount, loading:false, scenarioTitle:"", scenarioSetting:"", hiddenIssue:"", userResponses:[] }; document.getElementById("game-body").innerHTML = ""; document.getElementById("input-dock").style.display = "block"; showScreen("menu"); }

function renderStepJourney() {
    const el = document.getElementById("step-journey");
    const ci = STEPS.findIndex(s => s.key === state.currentStep);
    el.innerHTML = STEPS.map((step, i) => {
        const active = step.key === state.currentStep;
        const past = i < ci || state.currentStep === "COMPLETE";
        const cls = active ? "active" : past ? "past" : "";
        const dc = (active || past) ? step.color : "#374151";
        const score = state.stepScores[step.key];
        let sb = "";
        if (score !== undefined) { const sc = score >= 7 ? "sj-sc-hi" : score >= 4 ? "sj-sc-mid" : "sj-sc-lo"; sb = `<span class="sj-score ${sc}">${score}</span>`; }
        return `<div class="sj-step ${cls}"><span class="sj-dot" style="background:${dc};color:${dc}"></span><span class="sj-label">${step.label}</span>${sb}</div>`;
    }).join("");
}

async function callAPI(userMessage, isNew) {
    const msgs = isNew ? [{role:"user",content:userMessage}] : [...state.conversationHistory,{role:"user",content:userMessage}];
    const res = await fetch("/.netlify/functions/respond-api", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2000,system:SYSTEM_PROMPT,messages:msgs}) });
    if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error||`API error: ${res.status}`); }
    const data = await res.json(); const text = data.content?.map(c=>c.text||"").join("") || "";
    let cleaned = text.trim(); if (cleaned.startsWith("```")) cleaned = cleaned.replace(/```json?\n?/g,"").replace(/```$/g,"").trim();
    const parsed = JSON.parse(cleaned); state.conversationHistory = [...msgs, {role:"assistant",content:text}]; return parsed;
}

function addContent(html) { const body = document.getElementById("game-body"); body.insertAdjacentHTML("beforeend", html); body.lastElementChild?.scrollIntoView({ behavior: "smooth", block: "end" }); }

function renderScenario(d) {
    const s = getActiveStep();
    let h = `<div class="scene-card"><div class="scene-badge"><span class="scene-badge-dot" style="background:${s.color}"></span>SCENARIO</div>`;
    if (d.title) h += `<h2 class="scene-title">${esc(d.title)}</h2>`;
    if (d.setting) h += `<p class="scene-setting">${esc(d.setting)}</p>`;
    h += `<p class="scene-text">${esc(d.text)}</p></div>`;
    if (d.prompt) h += `<div class="prompt-card"><div class="prompt-step-tag" style="color:${s.color}">${s.label}</div><p class="prompt-text">${esc(d.prompt)}</p></div>`;
    addContent(h);
}

function renderUser(text) { addContent(`<div class="user-bubble"><p class="user-label">YOUR RESPONSE</p><p>${esc(text)}</p></div>`); }

function renderAssess(d) {
    const cls = d.critical ? "critical" : "normal";
    const bg = d.score >= 7 ? "#065F46" : d.score >= 4 ? "#78350F" : "#7F1D1D";
    const lc = d.score >= 7 ? "#34d399" : d.score >= 4 ? "#fbbf24" : "#f87171";
    const lt = d.score >= 7 ? "STRONG RESPONSE" : d.score >= 4 ? "ADEQUATE" : "NEEDS IMPROVEMENT";
    let h = `<div class="assess-card ${cls}"><div class="assess-score-circle" style="background:${bg}">${d.score}</div><div class="assess-body"><div class="assess-verdict" style="color:${lc}">${lt}</div><p class="assess-text">${esc(d.text)}</p>`;
    if (d.critical && d.criticalDetail) h += `<div class="critical-alert"><span class="critical-alert-tag">\u26a0 CRITICAL MISS</span><br>${esc(d.criticalDetail)}</div>`;
    h += `</div></div>`; addContent(h);
}

function renderDev(d) {
    const s = getActiveStep();
    let h = `<div class="dev-card"><p class="dev-text">${esc(d.text)}</p></div>`;
    if (d.prompt) h += `<div class="prompt-card"><div class="prompt-step-tag" style="color:${s.color}">${s.label}</div><p class="prompt-text">${esc(d.prompt)}</p></div>`;
    addContent(h);
}

function showTyping() { addContent(`<div class="typing-indicator" id="typing"><div class="typing-dots"><div class="td"></div><div class="td"></div><div class="td"></div></div><span class="typing-label">Assessing your response...</span></div>`); }
function hideTyping() { document.getElementById("typing")?.remove(); }
function updateRAG() { const el = document.getElementById("rag-badge"); el.className = `rag-pill rag-${state.ragStatus}`; el.innerHTML = `<span class="rp-dot"></span>${state.ragStatus}`; }
function updateStep() { document.getElementById("header-step").textContent = state.currentStep === "COMPLETE" ? "COMPLETE" : `STEP: ${state.currentStep}`; updateStepTheming(); }

function downloadPDF(d) {
    const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit: "mm", format: "a4" }); const W = 210, M = 20, CW = W - 2*M; let y = 20;
    const colors = { r:[36,67,123], e:[35,94,75], s:[164,104,78], p:[205,55,43], o:[235,175,36], n:[40,123,201], d:[134,37,235] };
    const dotR = 3, dotGap = 10, dotsW = 7*dotR*2 + 6*dotGap; let dx = (W - dotsW) / 2;
    STEPS.forEach(s => { const c = colors[s.letter.toLowerCase()]; doc.setFillColor(c[0],c[1],c[2]); doc.circle(dx+dotR, y+dotR, dotR, "F"); dx += dotR*2 + dotGap; }); y += 14;
    doc.setFont("helvetica","bold"); doc.setFontSize(22); doc.setTextColor(30,30,30); doc.text("RESPOND \u2014 Case Debrief", W/2, y, {align:"center"}); y += 8;
    doc.setFontSize(10); doc.setTextColor(120,120,120); doc.text(`${state.scenarioTitle}  |  ${new Date().toLocaleDateString("en-GB")}`, W/2, y, {align:"center"}); y += 12;
    doc.setFillColor(240,240,245); doc.roundedRect(M, y, CW, 20, 3, 3, "F");
    doc.setFont("helvetica","bold"); doc.setFontSize(16);
    const sc = d.overall_score >= 75 ? [5,150,105] : d.overall_score >= 50 ? [217,119,6] : [220,38,38];
    doc.setTextColor(sc[0],sc[1],sc[2]); doc.text(`${d.overall_score} / 100`, M+15, y+13);
    doc.setFontSize(11); const gc = {"Outstanding":[5,150,105],"Good":[37,99,235],"Requires Improvement":[217,119,6],"Inadequate":[220,38,38]};
    const gclr = gc[d.grade]||[60,60,60]; doc.setTextColor(gclr[0],gclr[1],gclr[2]); doc.text(d.grade, M+55, y+13);
    doc.setTextColor(100,100,100); doc.text(`RAG: ${d.rag_final}`, M+CW-15, y+13, {align:"right"}); y += 28;
    doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(30,30,30); doc.text("Step Scores", M, y); y += 6;
    STEPS.forEach(step => { const s = d.step_scores?.[step.key]; if(!s) return; if (y > 265) { doc.addPage(); y = 20; } const c = colors[step.letter.toLowerCase()]; doc.setFillColor(c[0],c[1],c[2]); doc.circle(M+3, y+3, 2.5, "F"); doc.setFont("helvetica","bold"); doc.setFontSize(10); doc.setTextColor(30,30,30); doc.text(step.label, M+9, y+4.5); const sclr = s.score>=7?[5,150,105]:s.score>=4?[217,119,6]:[220,38,38]; doc.setTextColor(sclr[0],sclr[1],sclr[2]); doc.text(`${s.score}/10`, M+45, y+4.5); doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(80,80,80); const lines = doc.splitTextToSize(s.feedback, CW-55); doc.text(lines, M+55, y+4.5); y += Math.max(8, lines.length*4 + 4); }); y += 6;
    if (y > 240) { doc.addPage(); y = 20; } doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(5,150,105); doc.text("Strengths", M, y); y += 5; doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(60,60,60); (d.strengths||[]).forEach(s => { const l=doc.splitTextToSize(`\u2022 ${s}`,CW); doc.text(l,M,y); y+=l.length*4+2; }); y += 4;
    doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(255,107,53); doc.text("Areas for Development", M, y); y += 5; doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(60,60,60); (d.areas_for_development||[]).forEach(s => { const l=doc.splitTextToSize(`\u2022 ${s}`,CW); doc.text(l,M,y); y+=l.length*4+2; }); y += 4;
    if (y > 250) { doc.addPage(); y = 20; } doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(37,99,235); doc.text("Key Learning", M, y); y += 5; doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(60,60,60); const kl = doc.splitTextToSize(d.key_learning, CW); doc.text(kl, M, y); y += kl.length*4 + 4;
    if (d.statutory_references?.length) { if (y > 255) { doc.addPage(); y = 20; } doc.setFont("helvetica","bold"); doc.setFontSize(9); doc.setTextColor(120,120,120); doc.text("STATUTORY REFERENCES", M, y); y += 4; doc.setFont("helvetica","normal"); doc.setFontSize(8); doc.setTextColor(140,140,140); d.statutory_references.forEach(r => { const l=doc.splitTextToSize(r,CW); doc.text(l,M,y); y+=l.length*3.5+2; }); }
    doc.setFontSize(7); doc.setTextColor(160,160,160); doc.text("RESPOND Safeguarding Simulator \u2014 respondsafeguarding.org \u2014 Training purposes only", W/2, 290, {align:"center"});
    const fname = `RESPOND_Debrief_${state.scenarioTitle.replace(/[^a-zA-Z0-9]/g,"_").substring(0,30)}_${new Date().toISOString().slice(0,10)}.pdf`; doc.save(fname);
}

async function logToSheet(debriefData) {
    if (!GOOGLE_SHEET_WEBHOOK) return;
    try { const d = debriefData; const payload = { timestamp: new Date().toISOString(), scenario_title: state.scenarioTitle, scenario_setting: state.scenarioSetting, hidden_issue: state.hiddenIssue, overall_score: d.overall_score, grade: d.grade, rag_final: d.rag_final, score_recognise: d.step_scores?.RECOGNISE?.score || "", score_engage: d.step_scores?.ENGAGE?.score || "", score_support: d.step_scores?.SUPPORT?.score || "", score_pause: d.step_scores?.PAUSE?.score || "", score_offer: d.step_scores?.OFFER?.score || "", score_notify: d.step_scores?.NOTIFY?.score || "", score_document: d.step_scores?.DOCUMENT?.score || "", strengths: (d.strengths||[]).join(" | "), areas_for_development: (d.areas_for_development||[]).join(" | "), key_learning: d.key_learning || "", statutory_references: (d.statutory_references||[]).join(" | "), user_responses: state.userResponses.map(r => `[${r.step}] ${r.response}`).join(" || ") };
    navigator.sendBeacon(GOOGLE_SHEET_WEBHOOK, new Blob([JSON.stringify(payload)], { type: "text/plain" }));
    } catch (e) { console.warn("Sheet log failed:", e); }
}

function renderDebrief(data) {
    const d = data.final_debrief; const gcMap = {"Outstanding":"#059669","Good":"#2563EB","Requires Improvement":"#D97706","Inadequate":"#DC2626"};
    const gclr = gcMap[d.grade] || "#fff"; const sclr = d.overall_score >= 75 ? "#059669" : d.overall_score >= 50 ? "#D97706" : "#DC2626";
    document.getElementById("input-dock").style.display = "none";
    let h = `<div class="debrief-wrap"><div class="db-header"><div class="db-dots">${STEPS.map(s=>`<div class="dbd" style="background:${s.color}"></div>`).join("")}</div><p class="db-title-text">Case Debrief</p><p class="db-case-title">${esc(state.scenarioTitle)}</p><div class="db-score-cluster"><div class="db-big-score" style="color:${sclr}">${d.overall_score}<span> / 100</span></div><div style="display:flex;flex-direction:column;align-items:center;gap:8px"><span class="db-grade-badge" style="color:${gclr};border-color:${gclr}">${d.grade}</span>${ragHtml(d.rag_final)}</div></div></div>`;
    h += `<div class="db-steps">`; STEPS.forEach((step, i) => { const s = d.step_scores?.[step.key]; if (!s) return; const c = s.score >= 7 ? "#34d399" : s.score >= 4 ? "#fbbf24" : "#f87171"; h += `<div class="db-step-cell" style="animation:fadeUp 0.4s ${0.1+i*0.06}s both"><span class="dsc-dot" style="background:${step.color}"></span><span class="dsc-letter">${step.label}</span><span class="dsc-score" style="color:${c}">${s.score}<span>/10</span></span><span class="dsc-fb">${esc(s.feedback)}</span></div>`; }); h += `</div>`;
    h += `<div class="db-body"><div class="db-section strengths"><h4 class="db-section-title">\u2713 Strengths</h4>${(d.strengths||[]).map(s=>`<p>${esc(s)}</p>`).join("")}</div><div class="db-section areas"><h4 class="db-section-title">\u26a1 Areas for Development</h4>${(d.areas_for_development||[]).map(s=>`<p>${esc(s)}</p>`).join("")}</div><div class="db-section learning"><h4 class="db-section-title">\ud83d\udcda Key Learning</h4><p>${esc(d.key_learning)}</p></div>`;
    if (d.statutory_references?.length) h += `<div class="db-section refs"><h4 class="db-section-title">Statutory References</h4>${d.statutory_references.map(r=>`<p>${esc(r)}</p>`).join("")}</div>`;
    h += `</div><div class="db-actions"><button class="btn-action secondary" onclick="downloadPDF(lastDebrief)">\ud83d\udcc4 Download PDF</button><button class="btn-action primary" onclick="startScenario()">Next Scenario \u2192</button><button class="btn-action ghost" onclick="resetGame()">Return to Menu</button></div></div>`;
    addContent(h); lastDebrief = d; logToSheet(d);
}

async function startScenario() {
    showScreen("loading"); document.getElementById("menu-error").style.display = "none";
    state.stepScores = {}; state.currentStep = "RECOGNISE"; state.ragStatus = "GREEN"; state.conversationHistory = []; state.loading = false;
    document.getElementById("game-body").innerHTML = ""; document.getElementById("input-dock").style.display = "block";
    try { const type = SCENARIO_TYPES[state.scenarioCount % SCENARIO_TYPES.length]; state.scenarioCount++;
    const demo = randomDemographic();
    const data = await callAPI(`Generate a new safeguarding training scenario. Type: ${type}.\n\nYou MUST use these exact demographics (non-negotiable):\n- Student name: ${demo.name}\n- Gender: ${demo.gender}\n- Nationality/heritage: ${demo.origin}\n- Grade: ${demo.grade}\n- Setting: ${demo.setting}, ${demo.day}\n\nMake it realistic for an international boarding school. Do NOT reveal the safeguarding issue \u2014 staff must identify it. Respond with ONLY valid JSON.`, true);
    state.ragStatus = data.severity || "GREEN"; state.scenarioTitle = data.title || ""; state.scenarioSetting = data.setting || ""; state.hiddenIssue = data.hidden_issue || ""; state.userResponses = [];
    updateRAG(); updateStep(); renderStepJourney(); showScreen("game");
    renderScenario({ title: data.title, setting: data.setting, text: data.initial_observation, prompt: data.prompt_to_user });
    document.getElementById("user-input").focus();
    } catch(err) { const el = document.getElementById("menu-error"); el.textContent = "Failed to generate scenario: " + err.message; el.style.display = "block"; showScreen("menu"); }
}

async function submitResponse() {
    const input = document.getElementById("user-input").value.trim(); if (!input || state.loading) return;
    document.getElementById("user-input").value = ""; state.loading = true;
    document.getElementById("btn-submit").disabled = true; document.getElementById("user-input").disabled = true;
    renderUser(input); state.userResponses.push({ step: state.currentStep, response: input }); showTyping();
    try { const data = await callAPI(`The user (staff member in training) responded to the current scenario at the ${state.currentStep} step:\n\n"${input}"\n\nAssess their response against the RESPOND framework ${state.currentStep} step requirements. Then develop the scenario further based on their choice. If they've now addressed enough RESPOND steps (at least through NOTIFY), you can move toward concluding the case. Respond with ONLY valid JSON.`, false);
    hideTyping(); if (data.rag_status) { state.ragStatus = data.rag_status; updateRAG(); }
    if (data.score && state.currentStep !== "COMPLETE") state.stepScores[state.currentStep] = data.score;
    if (data.current_step) { state.currentStep = data.current_step; updateStep(); } renderStepJourney();
    if (data.case_concluded && data.final_debrief) { renderAssess({ score: data.score, text: data.assessment, critical: data.critical_miss, criticalDetail: data.critical_miss_detail }); renderDebrief(data); }
    else { renderAssess({ score: data.score, text: data.assessment, critical: data.critical_miss, criticalDetail: data.critical_miss_detail }); renderDev({ text: data.next_development, prompt: data.prompt_to_user }); }
    } catch(err) { hideTyping(); addContent(`<div class="msg-error">Failed to process: ${esc(err.message)}. Please try again.</div>`); }
    state.loading = false; document.getElementById("btn-submit").disabled = false; document.getElementById("user-input").disabled = false; document.getElementById("user-input").focus();
}

document.addEventListener("DOMContentLoaded", initUI);
</script>
</body>
</html>