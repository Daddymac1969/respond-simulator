<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESPOND Safeguarding Simulator</title>
    <meta name="description" content="Interactive scenario-based safeguarding training powered by the RESPOND Framework.">
    <link rel="icon" type="image/png" href="https://github.com/Daddymac1969/respond/blob/main/RESPOND%20Concept%20copyrighted%20(1).png?raw=true">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body { font-family: 'Sora', -apple-system, sans-serif; line-height: 1.6; color: #C8D1DC; min-height: 100vh; background: #0c1018; overflow: hidden; }
        :root {
            --bg: #0c1018; --bg-elevated: #141b27; --bg-surface: #1a2332; --bg-overlay: #1e2a3a;
            --border: #253245; --border-light: #2e3e54;
            --text: #C8D1DC; --text-dim: #6b7a8d; --text-bright: #F1F5F9;
            --accent: #ff6b35;
            --step-r: #24437b; --step-e: #235e4b; --step-s: #a4684e; --step-p: #cd372b;
            --step-o: #ebaf24; --step-n: #287bc9; --step-d: #8625eb;
            --active-step: var(--step-r); --step-rgb: 36,67,123;
        }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes criticalFlash { 0% { background: #2a0a0a; } 25% { background: #3d0f0f; } 50% { background: #2a0a0a; } 100% { background: #1e0808; } }
        @keyframes dotBounce { 0%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-6px); } }
        @keyframes scoreReveal { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }

        /* MENU */
        .screen-menu { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; background: radial-gradient(ellipse at 30% 20%, rgba(36,67,123,0.08) 0%, transparent 60%), radial-gradient(ellipse at 70% 80%, rgba(134,37,235,0.06) 0%, transparent 60%), var(--bg); overflow-y: auto; }
        .menu-wrap { max-width: 520px; width: 100%; }
        .menu-hero { text-align: center; padding: 48px 32px 40px; }
        .menu-dots { display: flex; gap: 10px; justify-content: center; margin-bottom: 32px; }
        .menu-dots .md { width: 12px; height: 12px; border-radius: 50%; transition: transform 0.3s; }
        .menu-title { font-size: 44px; font-weight: 800; color: var(--text-bright); letter-spacing: -1.5px; margin: 0 0 4px; }
        .menu-subtitle { font-size: 15px; font-weight: 400; color: var(--text-dim); letter-spacing: 3px; text-transform: uppercase; margin: 0 0 28px; }
        .menu-desc { font-size: 14px; color: var(--text); line-height: 1.8; max-width: 400px; margin: 0 auto 32px; }
        .menu-steps { display: flex; flex-direction: column; gap: 0; margin: 0 0 32px; }
        .menu-step { display: flex; align-items: center; gap: 16px; padding: 14px 20px; border-bottom: 1px solid var(--border); }
        .menu-step:last-child { border-bottom: none; }
        .ms-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .ms-num { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-dim); min-width: 18px; }
        .ms-text { font-size: 13px; color: var(--text); }
        .btn-begin { display: block; width: 100%; padding: 16px 32px; border: none; border-radius: 10px; cursor: pointer; background: linear-gradient(135deg, #24437b, #287bc9); color: #fff; font-family: 'Sora', sans-serif; font-size: 15px; font-weight: 700; transition: all 0.3s; }
        .btn-begin:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(36,67,123,0.4); }
        #menu-error { display: none; padding: 12px 16px; border-radius: 10px; margin-top: 16px; background: #1e0808; border: 1px solid #5c1a1a; color: #f87171; font-size: 13px; }
        .menu-footer { text-align: center; margin-top: 20px; font-size: 11px; color: var(--text-dim); }
        .menu-footer a { color: var(--text-dim); text-decoration: underline; }

        /* LOADING */
        .screen-loading { display: none; align-items: center; justify-content: center; flex-direction: column; gap: 24px; min-height: 100vh; background: radial-gradient(ellipse at 50% 50%, rgba(36,67,123,0.1) 0%, transparent 70%), var(--bg); }
        .loading-bounce { display: flex; gap: 8px; }
        .loading-bounce .lb { width: 12px; height: 12px; border-radius: 50%; }
        .loading-bounce .lb:nth-child(1) { animation: dotBounce 1.2s 0s infinite; }
        .loading-bounce .lb:nth-child(2) { animation: dotBounce 1.2s 0.1s infinite; }
        .loading-bounce .lb:nth-child(3) { animation: dotBounce 1.2s 0.2s infinite; }
        .loading-bounce .lb:nth-child(4) { animation: dotBounce 1.2s 0.3s infinite; }
        .loading-bounce .lb:nth-child(5) { animation: dotBounce 1.2s 0.4s infinite; }
        .loading-bounce .lb:nth-child(6) { animation: dotBounce 1.2s 0.5s infinite; }
        .loading-bounce .lb:nth-child(7) { animation: dotBounce 1.2s 0.6s infinite; }
        .loading-text { font-size: 14px; color: var(--text-dim); font-weight: 500; }

        /* GAME SHELL */
        #screen-game { display: none; height: 100vh; flex-direction: column; }
        .game-header { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; height: 48px; background: rgba(12,16,24,0.92); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); z-index: 50; }
        .gh-left { display: flex; align-items: center; gap: 10px; }
        .gh-logo { width: 22px; height: 22px; border-radius: 4px; object-fit: contain; }
        .gh-brand { font-weight: 700; font-size: 12px; color: var(--text-bright); text-decoration: none; }
        .gh-divider { width: 1px; height: 18px; background: var(--border); }
        .rag-pill { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; letter-spacing: 1.5px; }
        .rag-pill .rp-dot { width: 6px; height: 6px; border-radius: 50%; }
        .rag-GREEN { background: rgba(5,150,105,0.15); color: #34d399; border: 1px solid rgba(5,150,105,0.3); } .rag-GREEN .rp-dot { background: #34d399; }
        .rag-AMBER { background: rgba(217,119,6,0.15); color: #fbbf24; border: 1px solid rgba(217,119,6,0.3); } .rag-AMBER .rp-dot { background: #fbbf24; }
        .rag-RED { background: rgba(220,38,38,0.15); color: #f87171; border: 1px solid rgba(220,38,38,0.3); } .rag-RED .rp-dot { background: #f87171; }
        .gh-right { display: flex; align-items: center; gap: 12px; }
        .gh-step-label { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-dim); }
        .btn-exit { padding: 4px 12px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); font-size: 11px; font-weight: 600; cursor: pointer; font-family: 'Sora', sans-serif; }
        .btn-exit:hover { border-color: #f87171; color: #f87171; }

        .step-journey { flex-shrink: 0; display: flex; height: 44px; border-bottom: 1px solid var(--border); background: var(--bg-elevated); }
        .sj-step { flex: 1; display: flex; align-items: center; justify-content: center; gap: 7px; padding: 0 6px; font-size: 11px; font-weight: 600; color: var(--text-dim); transition: all 0.4s; border-bottom: 3px solid transparent; opacity: 0.3; }
        .sj-step.active { opacity: 1; border-bottom-color: var(--active-step); background: linear-gradient(180deg, transparent 0%, rgba(var(--step-rgb), 0.08) 100%); }
        .sj-step.past { opacity: 0.65; }
        .sj-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .sj-step.active .sj-dot { width: 10px; height: 10px; box-shadow: 0 0 10px currentColor; }
        .sj-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sj-score { font-family: 'DM Mono', monospace; font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 10px; color: #fff; flex-shrink: 0; }
        .sj-sc-hi { background: #059669; } .sj-sc-mid { background: #b45309; } .sj-sc-lo { background: #dc2626; }

        /* TWO-PANEL LAYOUT */
        .game-panels { flex: 1; display: grid; grid-template-columns: 1fr 1fr; min-height: 0; overflow: hidden; }

        /* LEFT PANEL: CASE FILE */
        .panel-case { overflow-y: auto; padding: 28px; border-right: 1px solid var(--border); background: var(--bg); scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
        .panel-case::-webkit-scrollbar { width: 5px; } .panel-case::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .case-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 9px; font-weight: 700; letter-spacing: 2.5px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 20px; }
        .case-badge-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--active-step); }
        .case-title { font-size: 20px; font-weight: 800; color: var(--text-bright); letter-spacing: -0.5px; margin: 0 0 4px; line-height: 1.3; }
        .case-setting { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-dim); margin: 0 0 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .case-entry { animation: fadeUp 0.5s cubic-bezier(0.16,1,0.3,1) both; }
        .case-text { font-size: 14px; line-height: 1.85; color: var(--text); }
        .case-divider { height: 1px; background: var(--border); margin: 20px 0; }
        .case-step-tag { display: inline-flex; align-items: center; gap: 6px; font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 10px; padding: 4px 10px; border-radius: 4px; background: rgba(var(--step-rgb), 0.08); }
        .case-step-dot { width: 6px; height: 6px; border-radius: 50%; }
        .case-response { margin: 16px 0; padding: 12px 16px; border-radius: 8px; background: rgba(var(--step-rgb), 0.04); border-left: 3px solid var(--active-step); }
        .case-response-label { font-size: 9px; font-weight: 700; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 4px; text-transform: uppercase; }
        .case-response-text { font-size: 13px; line-height: 1.7; color: var(--text-bright); }
        .case-assessment { margin: 12px 0 0; padding: 10px 14px; border-radius: 8px; display: flex; gap: 12px; align-items: flex-start; }
        .case-assessment.good { background: rgba(5,150,105,0.06); border: 1px solid rgba(5,150,105,0.15); }
        .case-assessment.mid { background: rgba(217,119,6,0.06); border: 1px solid rgba(217,119,6,0.15); }
        .case-assessment.low { background: rgba(220,38,38,0.06); border: 1px solid rgba(220,38,38,0.15); }
        .ca-score { font-family: 'DM Mono', monospace; font-size: 14px; font-weight: 700; flex-shrink: 0; }
        .ca-score.good { color: #34d399; } .ca-score.mid { color: #fbbf24; } .ca-score.low { color: #f87171; }
        .ca-text { font-size: 12px; line-height: 1.6; color: var(--text); }
        .case-critical { margin: 8px 0 0; padding: 10px 14px; border-radius: 6px; background: rgba(220,38,38,0.08); border: 1px solid rgba(220,38,38,0.2); }
        .case-critical-tag { font-size: 8px; font-weight: 800; letter-spacing: 1px; color: #f87171; margin-bottom: 4px; }
        .case-critical-text { font-size: 11px; color: #fca5a5; line-height: 1.5; }

        /* RIGHT PANEL: WORKSPACE */
        .panel-work { overflow-y: auto; display: flex; flex-direction: column; background: var(--bg-elevated); scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
        .panel-work::-webkit-scrollbar { width: 5px; } .panel-work::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        .work-prompt { flex: 1; display: flex; flex-direction: column; padding: 28px; animation: slideIn 0.4s cubic-bezier(0.16,1,0.3,1) both; }
        .wp-step-header { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; }
        .wp-dot { width: 12px; height: 12px; border-radius: 50%; }
        .wp-step-name { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .wp-step-sub { font-size: 12px; color: var(--text-dim); }
        .wp-question { font-size: 15px; font-weight: 600; color: var(--text-bright); line-height: 1.7; margin-bottom: 28px; }
        .wp-input-area { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .wp-textarea { flex: 1; min-height: 120px; max-height: 300px; padding: 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-surface); color: var(--text-bright); font-size: 14px; line-height: 1.7; resize: none; font-family: 'Sora', sans-serif; outline: none; transition: border-color 0.3s, box-shadow 0.3s; }
        .wp-textarea:focus { border-color: var(--active-step); box-shadow: 0 0 0 3px rgba(var(--step-rgb), 0.1); }
        .wp-textarea::placeholder { color: var(--text-dim); }
        .wp-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; }
        .wp-hint { font-size: 10px; color: var(--text-dim); }
        .wp-submit { padding: 12px 28px; border-radius: 10px; border: none; color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; font-family: 'Sora', sans-serif; transition: all 0.2s; }
        .wp-submit:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .wp-submit:disabled { opacity: 0.3; cursor: not-allowed; transform: none; filter: none; }

        .work-assessing { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; padding: 28px; }
        .wa-dots { display: flex; gap: 6px; }
        .wa-dots span { width: 8px; height: 8px; border-radius: 50%; background: var(--active-step); animation: pulse 1.4s ease-in-out infinite; }
        .wa-dots span:nth-child(2) { animation-delay: 0.2s; }
        .wa-dots span:nth-child(3) { animation-delay: 0.4s; }
        .wa-label { font-size: 13px; color: var(--text-dim); font-weight: 500; }

        .work-feedback { flex: 1; display: flex; flex-direction: column; padding: 28px; animation: slideIn 0.5s cubic-bezier(0.16,1,0.3,1) both; }
        .wf-your-label { font-size: 9px; font-weight: 700; letter-spacing: 1.5px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; }
        .wf-your-text { font-size: 13px; line-height: 1.7; color: var(--text); padding: 14px 16px; border-radius: 10px; background: var(--bg-surface); border: 1px solid var(--border); margin-bottom: 24px; }
        .wf-score-row { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .wf-score-circle { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'DM Mono', monospace; font-size: 22px; font-weight: 700; color: #fff; animation: scoreReveal 0.4s 0.1s cubic-bezier(0.34,1.56,0.64,1) both; flex-shrink: 0; }
        .wf-verdict { font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; }
        .wf-step-tag { font-size: 10px; color: var(--text-dim); }
        .wf-assessment { font-size: 14px; line-height: 1.8; color: var(--text); margin-bottom: 20px; }
        .wf-critical { padding: 14px 16px; border-radius: 10px; background: #1e0808; border: 1px solid #5c1a1a; margin-bottom: 20px; animation: criticalFlash 1.5s ease; }
        .wf-critical-tag { display: inline-block; background: #dc2626; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 800; letter-spacing: 1px; margin-bottom: 8px; }
        .wf-critical-text { font-size: 13px; color: #fca5a5; line-height: 1.6; }
        .wf-continue { margin-top: auto; padding: 14px 32px; border-radius: 10px; border: none; color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; font-family: 'Sora', sans-serif; transition: all 0.2s; align-self: flex-end; }
        .wf-continue:hover { filter: brightness(1.2); transform: translateY(-1px); }

        /* DEBRIEF */
        .game-panels.debrief-mode { grid-template-columns: 1fr; }
        .panel-case.debrief-hidden { display: none; }
        .debrief-wrap { padding: 40px 32px 60px; max-width: 840px; margin: 0 auto; animation: fadeUp 0.8s cubic-bezier(0.16,1,0.3,1) both; }
        .db-header { text-align: center; padding: 0 0 32px; }
        .db-dots { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .db-dots .dbd { width: 10px; height: 10px; border-radius: 50%; }
        .db-title-text { font-size: 12px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 4px; }
        .db-case-title { font-size: 22px; font-weight: 800; color: var(--text-bright); margin-bottom: 24px; }
        .db-score-cluster { display: flex; align-items: center; justify-content: center; gap: 32px; flex-wrap: wrap; }
        .db-big-score { font-size: 56px; font-weight: 800; line-height: 1; animation: scoreReveal 0.6s cubic-bezier(0.34,1.56,0.64,1) both; }
        .db-big-score span { font-size: 20px; color: var(--text-dim); font-weight: 400; }
        .db-grade-badge { font-size: 14px; font-weight: 700; padding: 8px 20px; border-radius: 8px; border: 2px solid; }
        .db-steps { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-top: 28px; background: var(--border); }
        .db-step-cell { background: var(--bg-surface); padding: 16px 6px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .dsc-dot { width: 10px; height: 10px; border-radius: 50%; }
        .dsc-letter { font-size: 10px; font-weight: 700; color: var(--text-dim); }
        .dsc-score { font-size: 22px; font-weight: 800; line-height: 1; }
        .dsc-score span { font-size: 10px; color: var(--text-dim); font-weight: 400; }
        .dsc-fb { font-size: 10px; color: var(--text-dim); line-height: 1.4; margin-top: 4px; }
        .db-body { margin-top: 20px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .db-section { padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .db-section:last-child { border-bottom: none; }
        .db-section-title { font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
        .db-section.strengths { background: rgba(5,150,105,0.04); } .db-section.strengths .db-section-title { color: #34d399; } .db-section.strengths p { color: #a7f3d0; font-size: 13px; line-height: 1.7; margin: 4px 0; }
        .db-section.areas { background: rgba(255,107,53,0.04); } .db-section.areas .db-section-title { color: var(--accent); } .db-section.areas p { color: #ffd9c4; font-size: 13px; line-height: 1.7; margin: 4px 0; }
        .db-section.learning { background: rgba(37,99,235,0.04); } .db-section.learning .db-section-title { color: #93c5fd; } .db-section.learning p { color: #dbeafe; font-size: 14px; line-height: 1.8; margin: 0; }
        .db-section.refs .db-section-title { color: var(--text-dim); } .db-section.refs p { color: var(--text-dim); font-size: 12px; line-height: 1.5; margin: 2px 0; }
        .db-actions { display: flex; gap: 10px; justify-content: center; margin-top: 24px; flex-wrap: wrap; }
        .btn-action { padding: 12px 24px; border-radius: 10px; border: none; cursor: pointer; font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 700; transition: all 0.2s; }
        .btn-action.primary { background: linear-gradient(135deg, #24437b, #287bc9); color: #fff; }
        .btn-action.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(36,67,123,0.4); }
        .btn-action.secondary { background: var(--bg-surface); border: 1px solid var(--border); color: var(--text); }
        .btn-action.ghost { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
        .msg-error { margin: 14px 20px; padding: 14px 18px; border-radius: 12px; background: #1e0808; border: 1px solid #5c1a1a; color: #f87171; font-size: 13px; }

        @media (max-width: 840px) {
            .game-panels { grid-template-columns: 1fr; grid-template-rows: 2fr 3fr; }
            .panel-case { border-right: none; border-bottom: 1px solid var(--border); padding: 20px; }
        }
        @media (max-width: 640px) {
            .menu-title { font-size: 32px; } .menu-hero { padding: 32px 20px; }
            .sj-label { display: none; } .sj-step { min-width: 32px; gap: 0; flex-direction: column; padding: 0 3px; }
            .db-steps { grid-template-columns: repeat(4, 1fr); } .db-big-score { font-size: 40px; }
            .game-panels { grid-template-rows: 1fr 2fr; }
            .panel-case { padding: 16px; } .case-text { font-size: 13px; }
            .work-prompt, .work-feedback { padding: 20px; } .wp-question { font-size: 14px; }
        }
    </style>
</head>
<body>
<div id="screen-menu" class="screen-menu">
    <div class="menu-wrap"><div class="menu-hero">
        <div class="menu-dots" id="menu-dots"></div>
        <h1 class="menu-title">RESPOND</h1>
        <p class="menu-subtitle">Safeguarding Simulator</p>
        <p class="menu-desc">Navigate realistic safeguarding scenarios in real-time. Every decision is assessed against the RESPOND framework — building the recall-under-pressure skills that protect children.</p>
        <div class="menu-steps" id="menu-steps"></div>
        <div id="menu-error"></div>
        <button class="btn-begin" onclick="startScenario()">Begin Scenario</button>
    </div>
    <p class="menu-footer"><a href="https://www.respondsafeguarding.org/" target="_blank">respondsafeguarding.org</a> · <a href="mailto:darren@respondsafeguarding.org">darren@respondsafeguarding.org</a></p></div>
</div>
<div id="screen-loading" class="screen-loading"><div class="loading-bounce" id="loading-dots"></div><p class="loading-text">Generating your scenario...</p></div>
<div id="screen-game">
    <div class="game-header">
        <div class="gh-left">
            <img src="https://github.com/Daddymac1969/respond/blob/main/RESPOND%20Concept%20copyrighted%20(1).png?raw=true" alt="" class="gh-logo" onerror="this.style.display='none'">
            <a href="https://www.respondsafeguarding.org/" target="_blank" class="gh-brand">RESPOND</a>
            <div class="gh-divider"></div>
            <span id="rag-badge" class="rag-pill rag-GREEN"><span class="rp-dot"></span>GREEN</span>
        </div>
        <div class="gh-right">
            <span class="gh-step-label" id="header-step">STEP: RECOGNISE</span>
            <button class="btn-exit" onclick="resetGame()">✕ Exit</button>
        </div>
    </div>
    <div class="step-journey" id="step-journey"></div>
    <div class="game-panels" id="game-panels">
        <div class="panel-case" id="panel-case"></div>
        <div class="panel-work" id="panel-work"></div>
    </div>
</div>
<script>
const STEPS = [
    { key: "RECOGNISE", letter: "R", color: "#24437b", rgb: "36,67,123", label: "Recognise", sub: "Identify the concern" },
    { key: "ENGAGE", letter: "E", color: "#235e4b", rgb: "35,94,75", label: "Engage", sub: "Communicate effectively" },
    { key: "SUPPORT", letter: "S", color: "#a4684e", rgb: "164,104,78", label: "Support", sub: "Maintain composure" },
    { key: "PAUSE", letter: "P", color: "#cd372b", rgb: "205,55,43", label: "Pause", sub: "Consider your approach" },
    { key: "OFFER", letter: "O", color: "#ebaf24", rgb: "235,175,36", label: "Offer", sub: "Model alternatives" },
    { key: "NOTIFY", letter: "N", color: "#287bc9", rgb: "40,123,201", label: "Notify", sub: "Report the issue" },
    { key: "DOCUMENT", letter: "D", color: "#8625eb", rgb: "134,37,235", label: "Document", sub: "Record observations" },
];
const SCENARIO_TYPES = [
    "A nuanced scenario involving possible emotional abuse with cultural complexity",
    "A scenario involving concerning online behaviour and potential grooming",
    "A scenario involving peer-on-peer abuse disguised as normal social dynamics",
    "A scenario involving a student showing signs of neglect in a boarding context",
    "A scenario involving possible exploitation with contextual safeguarding factors",
    "A scenario involving self-harm indicators masked by academic pressure",
    "A scenario involving discrimination and identity-based harm",
    "A scenario involving a student displaying signs of radicalisation",
    "A scenario involving concerning staff-student boundary issues",
    "A scenario involving child-on-child sexual harassment normalised by peers",
];
const DEMO_NAMES={male:["James","Oliver","Mohammed","Kwame","Ravi","Carlos","Liam","Tom\u00e1s","Yusuf","Dmitri","Ethan","Kofi","Arjun","Matteo","Hiroshi","Zane","Idris","Finn","Rafael","Jakub","Noah","Tariq","Seb","Diego","Amir","Callum","Marcus","Theo","Luca","Andr\u00e9","Patrick","Chen Wei","Hassan","Nikolai","Brandon","Oscar","Jamal","Hugo","Aarav","Kenji"],female:["Sophie","Fatima","Mei-Lin","Chioma","Isabella","Aoife","Priya","Elena","Yuki","Zara","Chloe","Amina","Leila","Freya","Valentina","Ngozi","Saoirse","Hana","Rosa","Ingrid","Grace","Nadia","Lena","Adaeze","Marta","Sienna","Daria","Kira","Esme","Anya","Thandi","Astrid","Maya","Lucia","Jasmine","Pilar","Emilia","Aisha","Kayla","Mina"],nonbinary:["Alex","Sam","Jordan","Rowan","Kai","Ash","Quinn","Avery","River","Sky"]};
const DEMO_ORIGINS=["British","American","German","French","Nigerian","Kenyan","South African","Ghanaian","Indian","Pakistani","Sri Lankan","Bangladeshi","Japanese","Korean","Chinese","Filipino","Brazilian","Mexican","Colombian","Argentine","Irish","Polish","Italian","Spanish","Swedish","Norwegian","Dutch","Turkish","Egyptian","Lebanese","Iranian","Australian","Canadian","Jamaican","Trinidadian","Thai","Vietnamese","Russian","Ukrainian","Czech","Greek","Portuguese","Moroccan","Ethiopian","Tanzanian","New Zealand","Saudi Arabian","Emirati","Singaporean","Malaysian"];
const DEMO_GRADES=["Pre-K","K","1","2","3","4","5","6","7","8","9","10","11","12"];
const DEMO_SETTINGS=["Classroom during morning lessons","Campus dining hall at lunch","Dorm corridor during evening check-in","Sports field after practice","Art studio during free period","Library at study hall","School reception area at drop-off","Music practice room after school","Campus courtyard between classes","Boarding house common room after dinner","Computer lab during a lesson","Science lab during a practical","Backstage during rehearsals","Campus caf\u00e9 on a Saturday morning","School minibus returning from a trip","Medical centre waiting area","Corridor outside the head's office","Sixth form study area mid-morning","Swimming pool changing rooms","Chapel or reflection space during assembly"];
const DEMO_DAYS=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
let usedNames=[];
function randomDemographic(){const g=Math.random();const gender=g<0.42?"male":g<0.84?"female":"nonbinary";const pool=DEMO_NAMES[gender].filter(n=>!usedNames.includes(n));const p=pool.length>0?pool:DEMO_NAMES[gender];const name=p[Math.floor(Math.random()*p.length)];usedNames.push(name);if(usedNames.length>20)usedNames=usedNames.slice(-10);return{name,gender,origin:pick(DEMO_ORIGINS),grade:pick(DEMO_GRADES),setting:pick(DEMO_SETTINGS),day:pick(DEMO_DAYS)};}
function pick(a){return a[Math.floor(Math.random()*a.length)];}

const SYSTEM_PROMPT = "You are the RESPOND Safeguarding Training Simulator \\u2014 an AI engine for an interactive safeguarding training game used in UK schools (particularly international boarding schools). The RESPOND Framework is from respondsafeguarding.org.\n\n## YOUR ROLE\nYou guide staff through realistic safeguarding scenarios, assessing their decisions against the RESPOND framework (Recognise \\u2192 Engage \\u2192 Support \\u2192 Pause \\u2192 Offer \\u2192 Notify \\u2192 Document).\n\n## THE RESPOND FRAMEWORK\n\n**R \\u2013 RECOGNISE (Identify the concern)**: Identify safeguarding signs and trust your observations. Professional curiosity; noticing changes; cultural awareness. Ask: what type of harm? Who is involved? What context factors (people/places/platforms/patterns)?\n\n**E \\u2013 ENGAGE (Communicate effectively)**: Approach students with empathy and respect to build trust. Non-judgmental; age-appropriate; avoid leading questions. Use TED questions (Tell me, Explain, Describe \\u2014 NOT \\\"why\\\"). Say: \\\"I believe you. This is not your fault. You're safe right now.\\\"\n\n**S \\u2013 SUPPORT (Maintain composure)**: Consider what immediate emotional and practical assistance is tailored to needs. Validate without investigating; meet basic needs; cultural humility. Safety check: \\\"Are you safe now? Need medical attention?\\\" Provide private space, water, reassurance.\n\n**P \\u2013 PAUSE (Consider your approach)**: Take time to think carefully before acting to ensure appropriate response. DON'T investigate, promise secrecy, blame victim, or promise outcomes. Check policy; avoid investigation impulse. Use Three Lenses: Risk \\u2022 Rights \\u2022 Resources. IMPORTANT: Pause is an internal mental checkpoint, not going silent. It means stopping to think before your next action \\u2014 staff can still be present and reassuring while pausing internally.\n\n**O \\u2013 OFFER (Model alternatives)**: Identify relevant services and resources promptly. Only offer what you can deliver; respect autonomy where safe. Explain next steps: DSL notification, possible police/CSC, parent contact. Support options: school counselor, trusted adult, external services.\n\n**N \\u2013 NOTIFY (Report the issue)**: Inform designated safeguarding leads and senior managers as required. Within 30 minutes (immediately if crime in progress). Report: time, student details, what was disclosed, safety concerns, alleged perpetrator, evidence mentioned (NOT viewed). DSL coordinates with Police, CSC, SARC, parents.\n\n**D \\u2013 DOCUMENT (Record observations)**: Keep accurate, detailed records of safeguarding actions and observations. Record within 30 minutes. Use exact words: \\\"Student said: [quote]\\\" \\u2014 NO paraphrasing. Include: date, time, location, who present, student's words, demeanour, your actions. Use GOLD format (Ground, Observe, Language, Do).\n\n## RAG THRESHOLDS\n- **GREEN**: Low-level concern, monitor and record.\n- **AMBER**: Escalating concern or pattern. DSL must assess.\n- **RED**: Immediate risk of significant harm. DSL notified NOW.\n\n## GAME MECHANICS\n\n### When asked to generate a scenario:\nCreate a realistic, nuanced scenario for an international boarding school. The scenario should:\n- NOT reveal what the safeguarding issue is \\u2014 staff must identify it\n- Include subtle indicators that require professional curiosity\n- Have cultural, contextual, or environmental complexity\n- Unfold in layers\n- Be challenging but realistic\n\nRespond with ONLY valid JSON (no markdown, no backticks):\n{\n  \\\"scenario_id\\\": \\\"unique_id\\\",\n  \\\"title\\\": \\\"Brief evocative title\\\",\n  \\\"setting\\\": \\\"Where/when this takes place\\\",\n  \\\"initial_observation\\\": \\\"What the staff member sees/hears \\u2014 3-5 sentences MAX, concise but vivid, NO safeguarding labels\\\",\n  \\\"hidden_issue\\\": \\\"FOR SCORING ONLY - what is actually happening\\\",\n  \\\"severity\\\": \\\"GREEN|AMBER|RED\\\",\n  \\\"key_indicators\\\": [\\\"indicator1\\\", \\\"indicator2\\\", \\\"indicator3\\\"],\n  \\\"respond_step\\\": \\\"RECOGNISE\\\",\n  \\\"prompt_to_user\\\": \\\"A question asking the user what they notice and what they would do\\\"\n}\n\n### When assessing a user response:\nEvaluate against the current RESPOND step. Consider:\n- Did they identify the right concern?\n- Did they take appropriate action?\n- Did they avoid common pitfalls?\n- Was their response trauma-informed and culturally sensitive?\n- Give credit for contextually appropriate responses, even if they don't use exact framework phrases\n\nRespond with ONLY valid JSON:\n{\n  \\\"score\\\": 1-10,\n  \\\"assessment\\\": \\\"Brief, specific feedback\\\",\n  \\\"respond_step_met\\\": true/false,\n  \\\"critical_miss\\\": true/false,\n  \\\"critical_miss_detail\\\": \\\"Only if critical_miss is true\\\",\n  \\\"next_development\\\": \\\"The scenario develops further \\u2014 2-3 sentences MAX, keep it tight\\\",\n  \\\"current_step\\\": \\\"RECOGNISE|ENGAGE|SUPPORT|PAUSE|OFFER|NOTIFY|DOCUMENT\\\",\n  \\\"prompt_to_user\\\": \\\"Next question\\\",\n  \\\"case_concluded\\\": false,\n  \\\"rag_status\\\": \\\"GREEN|AMBER|RED\\\"\n}\n\n### When concluding a case:\n{\n  \\\"score\\\": 1-10,\n  \\\"assessment\\\": \\\"Final comprehensive feedback\\\",\n  \\\"respond_step_met\\\": true,\n  \\\"case_concluded\\\": true,\n  \\\"final_debrief\\\": {\n    \\\"overall_score\\\": 1-100,\n    \\\"grade\\\": \\\"Outstanding|Good|Requires Improvement|Inadequate\\\",\n    \\\"rag_final\\\": \\\"GREEN|AMBER|RED\\\",\n    \\\"step_scores\\\": {\n      \\\"RECOGNISE\\\": {\\\"score\\\": 1-10, \\\"feedback\\\": \\\"...\\\"},\n      \\\"ENGAGE\\\": {\\\"score\\\": 1-10, \\\"feedback\\\": \\\"...\\\"},\n      \\\"SUPPORT\\\": {\\\"score\\\": 1-10, \\\"feedback\\\": \\\"...\\\"},\n      \\\"PAUSE\\\": {\\\"score\\\": 1-10, \\\"feedback\\\": \\\"...\\\"},\n      \\\"OFFER\\\": {\\\"score\\\": 1-10, \\\"feedback\\\": \\\"...\\\"},\n      \\\"NOTIFY\\\": {\\\"score\\\": 1-10, \\\"feedback\\\": \\\"...\\\"},\n      \\\"DOCUMENT\\\": {\\\"score\\\": 1-10, \\\"feedback\\\": \\\"...\\\"}\n    },\n    \\\"strengths\\\": [\\\"strength1\\\", \\\"strength2\\\"],\n    \\\"areas_for_development\\\": [\\\"area1\\\", \\\"area2\\\"],\n    \\\"key_learning\\\": \\\"The most important takeaway\\\",\n    \\\"statutory_references\\\": [\\\"KCSIE 2025 reference\\\", \\\"Working Together 2023 reference\\\"]\n  },\n  \\\"next_development\\\": \\\"\\\",\n  \\\"current_step\\\": \\\"COMPLETE\\\",\n  \\\"prompt_to_user\\\": \\\"\\\"\n}\n\n## RULES\n- Never reveal the hidden issue until the debrief\n- Make scenarios culturally nuanced (international boarding school)\n- Include red herrings \\u2014 real life is messy\n- Reward professional curiosity, penalise assumptions\n- Flag dangerous choices as critical_miss\n- Keep tone supportive and educational\n- Keep ALL text outputs CONCISE \\u2014 scenarios 3-5 sentences, developments 2-3 sentences, assessments 1-2 sentences\n\n## INTERNATIONAL SCHOOL TERMINOLOGY\nUse: \\\"Grade\\\" not \\\"Year\\\", \\\"Faculty\\\" not \\\"teachers\\\", \\\"Campus\\\" not \\\"school grounds\\\", \\\"Dorm\\\" not \\\"house\\\", \\\"Semester\\\" not \\\"term\\\", \\\"Parent conference\\\" not \\\"parents' evening\\\", \\\"College counselor\\\" not \\\"careers adviser\\\".\n\n## ANTI-BIAS REQUIREMENTS \\u2014 CRITICAL\nUse exact demographics from user prompt. NEVER stereotypically link issues to ethnicity/nationality. Academic pressure can affect ANY nationality. Perpetrators reflect realistic diversity. Avoid cultural stereotyping.";

let state = { phase:"menu", currentStep:"RECOGNISE", ragStatus:"GREEN", stepScores:{}, conversationHistory:[], scenarioCount:0, loading:false, scenarioTitle:"", scenarioSetting:"", hiddenIssue:"", userResponses:[], journey:[], pendingFeedback:null };
const GOOGLE_SHEET_WEBHOOK = "https://script.google.com/macros/s/AKfycbyeZ0C-8Jg70QuFFeXBCNXRh7JjtXoAjUM7Utr0_OLHQjMGCc4N_5k0hlRxUUjl418y3w/exec";
let lastDebrief = null;

function esc(t) { const d = document.createElement("div"); d.textContent = t; return d.innerHTML; }
function ragHtml(s) { return `<span class="rag-pill rag-${s}"><span class="rp-dot"></span>${s}</span>`; }
function getActiveStep() { return STEPS.find(s => s.key === state.currentStep) || STEPS[0]; }
function updateStepTheming() { const s = getActiveStep(); document.documentElement.style.setProperty('--active-step', s.color); document.documentElement.style.setProperty('--step-rgb', s.rgb); }

function initUI() {
    document.getElementById("menu-dots").innerHTML = STEPS.map(s => `<div class="md" style="background:${s.color}"></div>`).join("");
    document.getElementById("menu-steps").innerHTML = STEPS.map((s,i) => `<div class="menu-step" style="animation:fadeUp 0.5s ${0.1+i*0.06}s both"><span class="ms-dot" style="background:${s.color}"></span><span class="ms-num">${s.letter}</span><span class="ms-text"><strong>${s.label}</strong> \u2014 ${s.sub}</span></div>`).join("");
    document.getElementById("loading-dots").innerHTML = STEPS.map(s => `<div class="lb" style="background:${s.color}"></div>`).join("");
}

function showScreen(n) {
    ["screen-menu","screen-loading","screen-game"].forEach(id => { document.getElementById(id).style.display = "none"; });
    const el = document.getElementById(`screen-${n}`);
    el.style.display = (n === "game") ? "flex" : "flex";
}

function resetGame() {
    state = { phase:"menu", currentStep:"RECOGNISE", ragStatus:"GREEN", stepScores:{}, conversationHistory:[], scenarioCount:state.scenarioCount, loading:false, scenarioTitle:"", scenarioSetting:"", hiddenIssue:"", userResponses:[], journey:[], pendingFeedback:null };
    document.getElementById("panel-case").innerHTML = "";
    document.getElementById("panel-work").innerHTML = "";
    document.getElementById("game-panels").className = "game-panels";
    document.getElementById("panel-case").className = "panel-case";
    showScreen("menu");
}

function renderStepJourney() {
    const el = document.getElementById("step-journey");
    const ci = STEPS.findIndex(s => s.key === state.currentStep);
    el.innerHTML = STEPS.map((step, i) => {
        const active = step.key === state.currentStep;
        const past = i < ci || state.currentStep === "COMPLETE";
        const cls = active ? "active" : past ? "past" : "";
        const dc = (active || past) ? step.color : "#374151";
        const score = state.stepScores[step.key];
        let sb = "";
        if (score !== undefined) { const sc = score >= 7 ? "sj-sc-hi" : score >= 4 ? "sj-sc-mid" : "sj-sc-lo"; sb = `<span class="sj-score ${sc}">${score}</span>`; }
        return `<div class="sj-step ${cls}"><span class="sj-dot" style="background:${dc};color:${dc}"></span><span class="sj-label">${step.label}</span>${sb}</div>`;
    }).join("");
}

function updateRAG() { const el = document.getElementById("rag-badge"); el.className = `rag-pill rag-${state.ragStatus}`; el.innerHTML = `<span class="rp-dot"></span>${state.ragStatus}`; }
function updateStep() { document.getElementById("header-step").textContent = state.currentStep === "COMPLETE" ? "COMPLETE" : `STEP: ${state.currentStep}`; updateStepTheming(); }

async function callAPI(userMessage, isNew) {
    const msgs = isNew ? [{role:"user",content:userMessage}] : [...state.conversationHistory,{role:"user",content:userMessage}];
    const res = await fetch("/.netlify/functions/respond-api", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2000,system:SYSTEM_PROMPT,messages:msgs}) });
    if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error||`API error: ${res.status}`); }
    const data = await res.json(); const text = data.content?.map(c=>c.text||"").join("") || "";
    let cleaned = text.trim(); if (cleaned.startsWith("```")) cleaned = cleaned.replace(/```json?\n?/g,"").replace(/```$/g,"").trim();
    const parsed = JSON.parse(cleaned); state.conversationHistory = [...msgs, {role:"assistant",content:text}]; return parsed;
}

/* === LEFT PANEL: CASE FILE === */
function renderCaseInitial(data) {
    document.getElementById("panel-case").innerHTML = `
        <div class="case-badge"><span class="case-badge-dot"></span>CASE FILE</div>
        <h2 class="case-title">${esc(data.title)}</h2>
        <p class="case-setting">${esc(data.setting)}</p>
        <div id="case-entries"><div class="case-entry"><p class="case-text">${esc(data.text)}</p></div></div>`;
}

function addCaseEntry(html) {
    const entries = document.getElementById("case-entries");
    entries.insertAdjacentHTML("beforeend", `<div class="case-divider"></div>${html}`);
    entries.lastElementChild?.scrollIntoView({ behavior: "smooth", block: "end" });
}

function addCaseResponse(step, text) {
    const s = STEPS.find(st => st.key === step) || STEPS[0];
    addCaseEntry(`<div class="case-entry"><div class="case-response" style="border-left-color:${s.color}"><p class="case-response-label">Your response \u2014 ${s.label}</p><p class="case-response-text">${esc(text)}</p></div></div>`);
}

function addCaseAssessment(score, text, critical, criticalDetail) {
    const cls = score >= 7 ? "good" : score >= 4 ? "mid" : "low";
    let h = `<div class="case-assessment ${cls}"><span class="ca-score ${cls}">${score}/10</span><span class="ca-text">${esc(text)}</span></div>`;
    if (critical && criticalDetail) h += `<div class="case-critical"><p class="case-critical-tag">\u26a0 CRITICAL MISS</p><p class="case-critical-text">${esc(criticalDetail)}</p></div>`;
    document.getElementById("case-entries").insertAdjacentHTML("beforeend", h);
}

function addCaseDevelopment(step, text) {
    const s = STEPS.find(st => st.key === step) || STEPS[0];
    addCaseEntry(`<div class="case-entry"><div class="case-step-tag" style="color:${s.color}"><span class="case-step-dot" style="background:${s.color}"></span>${s.label.toUpperCase()}</div><p class="case-text">${esc(text)}</p></div>`);
}

/* === RIGHT PANEL: WORKSPACE === */
function showPrompt(prompt) {
    const s = getActiveStep();
    document.getElementById("panel-work").innerHTML = `
        <div class="work-prompt">
            <div class="wp-step-header">
                <span class="wp-dot" style="background:${s.color}"></span>
                <span class="wp-step-name" style="color:${s.color}">${s.label}</span>
                <span class="wp-step-sub">\u2014 ${s.sub}</span>
            </div>
            <p class="wp-question">${esc(prompt)}</p>
            <div class="wp-input-area">
                <textarea id="user-input" class="wp-textarea" rows="4" placeholder="Describe what you would do..."></textarea>
                <div class="wp-footer">
                    <span class="wp-hint">Shift+Enter for new line</span>
                    <button id="btn-submit" class="wp-submit" style="background:${s.color}" onclick="submitResponse()">Submit \u2192</button>
                </div>
            </div>
        </div>`;
    const ta = document.getElementById("user-input");
    ta.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); submitResponse(); } });
    ta.focus();
}

function showAssessing() {
    document.getElementById("panel-work").innerHTML = `<div class="work-assessing"><div class="wa-dots"><span></span><span></span><span></span></div><p class="wa-label">Assessing your response...</p></div>`;
}

function showFeedback(userText, score, assessment, critical, criticalDetail, isFinal) {
    const s = getActiveStep();
    const bg = score >= 7 ? "#065F46" : score >= 4 ? "#78350F" : "#7F1D1D";
    const lc = score >= 7 ? "#34d399" : score >= 4 ? "#fbbf24" : "#f87171";
    const lt = score >= 7 ? "STRONG RESPONSE" : score >= 4 ? "ADEQUATE" : "NEEDS IMPROVEMENT";
    let h = `<div class="work-feedback">
        <p class="wf-your-label">Your Response</p>
        <div class="wf-your-text">${esc(userText)}</div>
        <div class="wf-score-row">
            <div class="wf-score-circle" style="background:${bg}">${score}</div>
            <div><p class="wf-verdict" style="color:${lc}">${lt}</p><p class="wf-step-tag">${s.label} step</p></div>
        </div>
        <p class="wf-assessment">${esc(assessment)}</p>`;
    if (critical && criticalDetail) h += `<div class="wf-critical"><span class="wf-critical-tag">\u26a0 CRITICAL MISS</span><p class="wf-critical-text">${esc(criticalDetail)}</p></div>`;
    if (!isFinal) h += `<button class="wf-continue" style="background:${s.color}" onclick="continueToNext()">Continue \u2192</button>`;
    h += `</div>`;
    document.getElementById("panel-work").innerHTML = h;
}

function continueToNext() {
    const fb = state.pendingFeedback; if (!fb) return;
    state.pendingFeedback = null;
    addCaseDevelopment(fb.nextStep, fb.devText);
    state.currentStep = fb.nextStep;
    updateStep(); renderStepJourney();
    showPrompt(fb.prompt);
}

/* === DEBRIEF === */
function renderDebrief(data) {
    const d = data.final_debrief;
    const gcMap = {"Outstanding":"#059669","Good":"#2563EB","Requires Improvement":"#D97706","Inadequate":"#DC2626"};
    const gclr = gcMap[d.grade] || "#fff";
    const sclr = d.overall_score >= 75 ? "#059669" : d.overall_score >= 50 ? "#D97706" : "#DC2626";
    document.getElementById("game-panels").className = "game-panels debrief-mode";
    document.getElementById("panel-case").className = "panel-case debrief-hidden";
    let h = `<div class="debrief-wrap"><div class="db-header"><div class="db-dots">${STEPS.map(s=>`<div class="dbd" style="background:${s.color}"></div>`).join("")}</div><p class="db-title-text">Case Debrief</p><p class="db-case-title">${esc(state.scenarioTitle)}</p><div class="db-score-cluster"><div class="db-big-score" style="color:${sclr}">${d.overall_score}<span> / 100</span></div><div style="display:flex;flex-direction:column;align-items:center;gap:8px"><span class="db-grade-badge" style="color:${gclr};border-color:${gclr}">${d.grade}</span>${ragHtml(d.rag_final)}</div></div></div>`;
    h += `<div class="db-steps">`; STEPS.forEach((step, i) => { const s = d.step_scores?.[step.key]; if (!s) return; const c = s.score >= 7 ? "#34d399" : s.score >= 4 ? "#fbbf24" : "#f87171"; h += `<div class="db-step-cell" style="animation:fadeUp 0.4s ${0.1+i*0.06}s both"><span class="dsc-dot" style="background:${step.color}"></span><span class="dsc-letter">${step.label}</span><span class="dsc-score" style="color:${c}">${s.score}<span>/10</span></span><span class="dsc-fb">${esc(s.feedback)}</span></div>`; }); h += `</div>`;
    h += `<div class="db-body"><div class="db-section strengths"><h4 class="db-section-title">\u2713 Strengths</h4>${(d.strengths||[]).map(s=>`<p>${esc(s)}</p>`).join("")}</div><div class="db-section areas"><h4 class="db-section-title">\u26a1 Areas for Development</h4>${(d.areas_for_development||[]).map(s=>`<p>${esc(s)}</p>`).join("")}</div><div class="db-section learning"><h4 class="db-section-title">\ud83d\udcda Key Learning</h4><p>${esc(d.key_learning)}</p></div>`;
    if (d.statutory_references?.length) h += `<div class="db-section refs"><h4 class="db-section-title">Statutory References</h4>${d.statutory_references.map(r=>`<p>${esc(r)}</p>`).join("")}</div>`;
    h += `</div><div class="db-actions"><button class="btn-action secondary" onclick="downloadPDF(lastDebrief)">\ud83d\udcc4 Download Case Record</button><button class="btn-action primary" onclick="startScenario()">Next Scenario \u2192</button><button class="btn-action ghost" onclick="resetGame()">Return to Menu</button></div></div>`;
    document.getElementById("panel-work").innerHTML = h;
    lastDebrief = d; logToSheet(d);
}

/* === GAME FLOW === */
async function startScenario() {
    showScreen("loading"); document.getElementById("menu-error").style.display = "none";
    state.stepScores = {}; state.currentStep = "RECOGNISE"; state.ragStatus = "GREEN"; state.conversationHistory = []; state.loading = false; state.journey = []; state.pendingFeedback = null;
    document.getElementById("panel-case").innerHTML = ""; document.getElementById("panel-case").className = "panel-case";
    document.getElementById("panel-work").innerHTML = ""; document.getElementById("game-panels").className = "game-panels";
    try {
        const type = SCENARIO_TYPES[state.scenarioCount % SCENARIO_TYPES.length]; state.scenarioCount++;
        const demo = randomDemographic();
        const data = await callAPI(`Generate a new safeguarding training scenario. Type: ${type}.\n\nYou MUST use these exact demographics (non-negotiable):\n- Student name: ${demo.name}\n- Gender: ${demo.gender}\n- Nationality/heritage: ${demo.origin}\n- Grade: ${demo.grade}\n- Setting: ${demo.setting}, ${demo.day}\n\nMake it realistic for an international boarding school. Do NOT reveal the safeguarding issue \u2014 staff must identify it. Respond with ONLY valid JSON.`, true);
        state.ragStatus = data.severity || "GREEN"; state.scenarioTitle = data.title || ""; state.scenarioSetting = data.setting || ""; state.hiddenIssue = data.hidden_issue || ""; state.userResponses = [];
        state.journey.push({ type:"scenario", step:"RECOGNISE", title:data.title, setting:data.setting, text:data.initial_observation, prompt:data.prompt_to_user });
        updateRAG(); updateStep(); renderStepJourney(); showScreen("game");
        renderCaseInitial({ title: data.title, setting: data.setting, text: data.initial_observation });
        showPrompt(data.prompt_to_user);
    } catch(err) { document.getElementById("menu-error").textContent = "Failed: " + err.message; document.getElementById("menu-error").style.display = "block"; showScreen("menu"); }
}

async function submitResponse() {
    const ta = document.getElementById("user-input");
    const input = ta?.value.trim(); if (!input || state.loading) return;
    state.loading = true;
    const submittedStep = state.currentStep;
    addCaseResponse(submittedStep, input);
    state.userResponses.push({ step: submittedStep, response: input });
    state.journey.push({ type:"response", step:submittedStep, text:input });
    showAssessing();
    try {
        const data = await callAPI(`The user (staff member in training) responded to the current scenario at the ${submittedStep} step:\n\n"${input}"\n\nAssess their response against the RESPOND framework ${submittedStep} step requirements. Then develop the scenario further based on their choice. If they've now addressed enough RESPOND steps (at least through NOTIFY), you can move toward concluding the case. Respond with ONLY valid JSON.`, false);
        if (data.rag_status) { state.ragStatus = data.rag_status; updateRAG(); }
        if (data.score && submittedStep !== "COMPLETE") state.stepScores[submittedStep] = data.score;
        state.journey.push({ type:"assessment", step:submittedStep, score:data.score, text:data.assessment, critical:data.critical_miss||false, criticalDetail:data.critical_miss_detail||"" });
        addCaseAssessment(data.score, data.assessment, data.critical_miss, data.critical_miss_detail);
        if (data.case_concluded && data.final_debrief) {
            if (data.current_step) { state.currentStep = data.current_step; updateStep(); }
            renderStepJourney();
            showFeedback(input, data.score, data.assessment, data.critical_miss, data.critical_miss_detail, true);
            setTimeout(() => renderDebrief(data), 2000);
        } else {
            const nextStep = data.current_step || submittedStep;
            state.journey.push({ type:"development", step:nextStep, text:data.next_development, prompt:data.prompt_to_user });
            state.pendingFeedback = { nextStep, devText: data.next_development, prompt: data.prompt_to_user };
            if (data.current_step) { state.currentStep = data.current_step; updateStep(); }
            renderStepJourney();
            showFeedback(input, data.score, data.assessment, data.critical_miss, data.critical_miss_detail, false);
        }
    } catch(err) {
        document.getElementById("panel-work").innerHTML = `<div class="msg-error">Failed: ${esc(err.message)}. Please try again.</div>`;
        setTimeout(() => showPrompt(state.journey.filter(j=>j.type==="development"||j.type==="scenario").pop()?.prompt || "What would you do?"), 2000);
    }
    state.loading = false;
}

/* === PDF: FULL CASE RECORD === */
function downloadPDF(d) {
    const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit: "mm", format: "a4" }); const W = 210, M = 20, CW = W - 2*M; let y = 20;
    const colors = { r:[36,67,123], e:[35,94,75], s:[164,104,78], p:[205,55,43], o:[235,175,36], n:[40,123,201], d:[134,37,235] };
    const stepColorMap = { RECOGNISE:colors.r, ENGAGE:colors.e, SUPPORT:colors.s, PAUSE:colors.p, OFFER:colors.o, NOTIFY:colors.n, DOCUMENT:colors.d };
    const footer = () => { doc.setFontSize(7); doc.setTextColor(160,160,160); doc.text("RESPOND Safeguarding Simulator \u2014 respondsafeguarding.org \u2014 Training purposes only", W/2, 290, {align:"center"}); };
    const checkPage = (need) => { if (y + need > 275) { footer(); doc.addPage(); y = 20; } };
    const drawText = (txt, x, maxW, size, style, clr, lh) => { doc.setFont("helvetica", style||"normal"); doc.setFontSize(size||10); doc.setTextColor(clr?clr[0]:60, clr?clr[1]:60, clr?clr[2]:60); const lines = doc.splitTextToSize(txt, maxW||CW); checkPage(lines.length * (lh||4.5) + 2); doc.text(lines, x||M, y); y += lines.length * (lh||4.5); return lines.length; };

    /* COVER */
    const dotR = 3, dotGap = 10, dotsW = 7*dotR*2 + 6*dotGap; let dx = (W - dotsW) / 2;
    STEPS.forEach(s => { const c = colors[s.letter.toLowerCase()]; doc.setFillColor(c[0],c[1],c[2]); doc.circle(dx+dotR, y+dotR, dotR, "F"); dx += dotR*2 + dotGap; }); y += 16;
    doc.setFont("helvetica","bold"); doc.setFontSize(24); doc.setTextColor(30,30,30); doc.text("RESPOND", W/2, y, {align:"center"}); y += 7;
    doc.setFontSize(11); doc.setTextColor(120,120,120); doc.text("Safeguarding Simulator \u2014 Case Record", W/2, y, {align:"center"}); y += 14;
    doc.setDrawColor(200,200,200); doc.line(M, y, W-M, y); y += 10;
    doc.setFont("helvetica","bold"); doc.setFontSize(18); doc.setTextColor(30,30,30); doc.text(state.scenarioTitle || "Case Record", W/2, y, {align:"center"}); y += 8;
    doc.setFont("helvetica","normal"); doc.setFontSize(10); doc.setTextColor(120,120,120); doc.text(new Date().toLocaleDateString("en-GB", {weekday:"long",year:"numeric",month:"long",day:"numeric"}), W/2, y, {align:"center"}); y += 14;
    doc.setFillColor(245,245,250); doc.roundedRect(M, y, CW, 24, 4, 4, "F");
    const sc = d.overall_score >= 75 ? [5,150,105] : d.overall_score >= 50 ? [217,119,6] : [220,38,38];
    doc.setFont("helvetica","bold"); doc.setFontSize(20); doc.setTextColor(sc[0],sc[1],sc[2]); doc.text(`${d.overall_score} / 100`, M+15, y+15);
    const gc = {"Outstanding":[5,150,105],"Good":[37,99,235],"Requires Improvement":[217,119,6],"Inadequate":[220,38,38]};
    const gclr = gc[d.grade]||[60,60,60]; doc.setFontSize(12); doc.setTextColor(gclr[0],gclr[1],gclr[2]); doc.text(d.grade, M+60, y+15);
    doc.setFontSize(10); doc.setTextColor(100,100,100); doc.text(`RAG: ${d.rag_final}`, M+CW-15, y+15, {align:"right"}); y += 32;
    const cellW = CW / 7;
    STEPS.forEach((step, i) => { const s = d.step_scores?.[step.key]; const cx = M + i*cellW + cellW/2; const c = colors[step.letter.toLowerCase()]; doc.setFillColor(c[0],c[1],c[2]); doc.circle(cx, y+3, 2.5, "F"); doc.setFont("helvetica","bold"); doc.setFontSize(8); doc.setTextColor(80,80,80); doc.text(step.letter, cx, y+10, {align:"center"}); if (s) { const sclr = s.score>=7?[5,150,105]:s.score>=4?[217,119,6]:[220,38,38]; doc.setFontSize(11); doc.setTextColor(sclr[0],sclr[1],sclr[2]); doc.text(`${s.score}`, cx, y+17, {align:"center"}); } }); y += 24;
    footer(); doc.addPage(); y = 20;

    /* CASE WALKTHROUGH */
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(30,30,30); doc.text("CASE WALKTHROUGH", M, y); y += 3;
    doc.setDrawColor(36,67,123); doc.setLineWidth(0.8); doc.line(M, y, M+40, y); doc.setLineWidth(0.2); y += 10;
    let currentStepLabel = "";
    state.journey.forEach((ev) => {
        const clr = stepColorMap[ev.step] || [80,80,80];
        const stepObj = STEPS.find(s => s.key === ev.step) || { label: ev.step };
        if (ev.type === "scenario") {
            checkPage(50);
            doc.setFont("helvetica","bold"); doc.setFontSize(10); doc.setTextColor(clr[0],clr[1],clr[2]);
            doc.text(`\u25cf  ${stepObj.label.toUpperCase()} \u2014 Initial Scenario`, M, y); y += 7;
            if (ev.title) { drawText(ev.title, M+6, CW-6, 12, "bold", [30,30,30]); y += 2; }
            if (ev.setting) { doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(120,120,120); doc.text(ev.setting, M+6, y); y += 5; }
            drawText(ev.text, M+6, CW-6, 10, "normal", [50,50,50], 4.5); y += 4;
            if (ev.prompt) { checkPage(12); doc.setFont("helvetica","bold"); doc.setFontSize(9); doc.setTextColor(clr[0],clr[1],clr[2]); doc.text("PROMPT:", M+6, y); y += 4; drawText(ev.prompt, M+6, CW-6, 10, "normal", [40,40,40], 4.5); y += 6; }
            doc.setDrawColor(220,220,220); doc.line(M, y, W-M, y); y += 8; currentStepLabel = ev.step;
        } else if (ev.type === "response") {
            checkPage(18); doc.setFont("helvetica","bold"); doc.setFontSize(9); doc.setTextColor(100,100,100); doc.text("YOUR RESPONSE", M+6, y); y += 5;
            const respLines = doc.splitTextToSize(ev.text, CW-12); const rh = respLines.length * 4.5 + 6;
            checkPage(rh); doc.setFillColor(240,243,248); doc.roundedRect(M+4, y-4, CW-4, rh, 3, 3, "F");
            doc.setFont("helvetica","normal"); doc.setFontSize(10); doc.setTextColor(40,40,40); doc.text(respLines, M+8, y); y += rh + 2;
        } else if (ev.type === "assessment") {
            checkPage(22); const sclr = ev.score>=7?[5,150,105]:ev.score>=4?[217,119,6]:[220,38,38];
            const verdict = ev.score>=7?"STRONG RESPONSE":ev.score>=4?"ADEQUATE":"NEEDS IMPROVEMENT";
            doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(sclr[0],sclr[1],sclr[2]); doc.text(`${ev.score}/10`, M+6, y);
            doc.setFontSize(9); doc.text(verdict, M+20, y); y += 5;
            drawText(ev.text, M+6, CW-6, 9, "normal", [80,80,80], 4); y += 2;
            if (ev.critical && ev.criticalDetail) {
                checkPage(14); const cmLines = doc.splitTextToSize(ev.criticalDetail, CW-16); const cmH = cmLines.length * 4 + 8;
                doc.setFillColor(255,240,240); doc.roundedRect(M+4, y-2, CW-4, cmH, 3, 3, "F"); doc.setDrawColor(220,60,60); doc.roundedRect(M+4, y-2, CW-4, cmH, 3, 3, "S");
                doc.setFont("helvetica","bold"); doc.setFontSize(8); doc.setTextColor(220,38,38); doc.text("\u26a0 CRITICAL MISS", M+8, y+2); y += 6;
                doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(180,30,30); doc.text(cmLines, M+8, y); y += cmLines.length * 4 + 4;
            }
            doc.setDrawColor(220,220,220); doc.line(M, y, W-M, y); y += 8;
        } else if (ev.type === "development") {
            if (ev.step !== currentStepLabel) { checkPage(12); const devClr = stepColorMap[ev.step]||[80,80,80]; const devObj = STEPS.find(s=>s.key===ev.step)||{label:ev.step}; doc.setFont("helvetica","bold"); doc.setFontSize(10); doc.setTextColor(devClr[0],devClr[1],devClr[2]); doc.text(`\u25cf  ${devObj.label.toUpperCase()}`, M, y); y += 7; currentStepLabel = ev.step; }
            if (ev.text) { drawText(ev.text, M+6, CW-6, 10, "normal", [50,50,50], 4.5); y += 4; }
            if (ev.prompt) { checkPage(12); const pClr = stepColorMap[ev.step]||[80,80,80]; doc.setFont("helvetica","bold"); doc.setFontSize(9); doc.setTextColor(pClr[0],pClr[1],pClr[2]); doc.text("PROMPT:", M+6, y); y += 4; drawText(ev.prompt, M+6, CW-6, 10, "normal", [40,40,40], 4.5); y += 6; }
        }
    });

    /* DEBRIEF */
    footer(); doc.addPage(); y = 20;
    dx = (W - dotsW) / 2; STEPS.forEach(s => { const c = colors[s.letter.toLowerCase()]; doc.setFillColor(c[0],c[1],c[2]); doc.circle(dx+dotR, y+dotR, dotR, "F"); dx += dotR*2 + dotGap; }); y += 14;
    doc.setFont("helvetica","bold"); doc.setFontSize(16); doc.setTextColor(30,30,30); doc.text("DEBRIEF ANALYSIS", W/2, y, {align:"center"}); y += 12;
    STEPS.forEach(step => { const s = d.step_scores?.[step.key]; if(!s) return; checkPage(16); const c = colors[step.letter.toLowerCase()]; doc.setFillColor(c[0],c[1],c[2]); doc.circle(M+3, y+3, 2.5, "F"); doc.setFont("helvetica","bold"); doc.setFontSize(10); doc.setTextColor(30,30,30); doc.text(step.label, M+9, y+4.5); const sclr = s.score>=7?[5,150,105]:s.score>=4?[217,119,6]:[220,38,38]; doc.setTextColor(sclr[0],sclr[1],sclr[2]); doc.text(`${s.score}/10`, M+45, y+4.5); doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(80,80,80); const lines = doc.splitTextToSize(s.feedback, CW-55); doc.text(lines, M+55, y+4.5); y += Math.max(10, lines.length*4 + 6); }); y += 6;
    checkPage(20); doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(5,150,105); doc.text("\u2713 Strengths", M, y); y += 6; doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(60,60,60); (d.strengths||[]).forEach(s => { const l=doc.splitTextToSize(`\u2022 ${s}`,CW); checkPage(l.length*4+3); doc.text(l,M+4,y); y+=l.length*4+3; }); y += 4;
    checkPage(20); doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(255,107,53); doc.text("\u26a1 Areas for Development", M, y); y += 6; doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(60,60,60); (d.areas_for_development||[]).forEach(s => { const l=doc.splitTextToSize(`\u2022 ${s}`,CW); checkPage(l.length*4+3); doc.text(l,M+4,y); y+=l.length*4+3; }); y += 4;
    checkPage(16); doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(37,99,235); doc.text("Key Learning", M, y); y += 6; doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(60,60,60); const kl = doc.splitTextToSize(d.key_learning, CW); checkPage(kl.length*4+4); doc.text(kl, M, y); y += kl.length*4 + 6;
    if (d.statutory_references?.length) { checkPage(12); doc.setFont("helvetica","bold"); doc.setFontSize(9); doc.setTextColor(120,120,120); doc.text("STATUTORY REFERENCES", M, y); y += 5; doc.setFont("helvetica","normal"); doc.setFontSize(8); doc.setTextColor(140,140,140); d.statutory_references.forEach(r => { const l=doc.splitTextToSize(r,CW); checkPage(l.length*3.5+3); doc.text(l,M,y); y+=l.length*3.5+3; }); }
    footer();
    doc.save(`RESPOND_Case_Record_${state.scenarioTitle.replace(/[^a-zA-Z0-9]/g,"_").substring(0,30)}_${new Date().toISOString().slice(0,10)}.pdf`);
}

/* === SHEET LOGGING === */
async function logToSheet(debriefData) {
    if (!GOOGLE_SHEET_WEBHOOK) return;
    try { const d = debriefData; const payload = { timestamp: new Date().toISOString(), scenario_title: state.scenarioTitle, scenario_setting: state.scenarioSetting, hidden_issue: state.hiddenIssue, overall_score: d.overall_score, grade: d.grade, rag_final: d.rag_final, score_recognise: d.step_scores?.RECOGNISE?.score||"", score_engage: d.step_scores?.ENGAGE?.score||"", score_support: d.step_scores?.SUPPORT?.score||"", score_pause: d.step_scores?.PAUSE?.score||"", score_offer: d.step_scores?.OFFER?.score||"", score_notify: d.step_scores?.NOTIFY?.score||"", score_document: d.step_scores?.DOCUMENT?.score||"", strengths: (d.strengths||[]).join(" | "), areas_for_development: (d.areas_for_development||[]).join(" | "), key_learning: d.key_learning||"", statutory_references: (d.statutory_references||[]).join(" | "), user_responses: state.userResponses.map(r => `[${r.step}] ${r.response}`).join(" || "), scenario_text: state.journey.find(j=>j.type==="scenario")?.text||"", critical_misses: state.journey.filter(j=>j.type==="assessment"&&j.critical).map(j=>`[${j.step}] ${j.criticalDetail}`).join(" || ") };
    navigator.sendBeacon(GOOGLE_SHEET_WEBHOOK, new Blob([JSON.stringify(payload)], { type: "text/plain" }));
    } catch (e) { console.warn("Sheet log failed:", e); }
}

document.addEventListener("DOMContentLoaded", initUI);

</script>
</body>
</html>
